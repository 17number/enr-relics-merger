<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">ELDEN RING NIGHTREIGN éºç‰©ç”»åƒçµåˆãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; background: #f8f9fa; color:#333; font-size: 16px; }
    h1 { font-size: 1.4rem; }
    .input-area { display: flex; gap: 20px; flex-wrap: wrap; }
    .pattern-block input[type="radio"], .pattern-block label { cursor: pointer; }
    .file-block { flex: 1; min-width: 200px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .file-block h3 { margin: 0 0 8px; font-size: 1rem; }
    .preview { display:block; max-width: min(400px, 80vw); max-height: 400px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    .drop-zone { border: 2px dashed #999; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center; color: #666; background:#fff; }
    .drop-zone.dragover { border-color: #333; background: #f0f0f0; }
    button, a { margin: 10px 5px 20px 0; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px; cursor: pointer; }
    #swap { background:#3399ff; color:#fff; }
    #generate { background:#007bff; color:#fff; }
    #generate:disabled { background:#ccc; cursor:not-allowed; }
    #reset { background:#dc3545; color:#fff; }
    #download { background:#28a745; color:#fff; display:none; text-decoration:none; }
    #copy { background:#17a2b8; color:#fff; display:none; }
    #canvas { display:none; }
    #output { display:none; }
    #output-img { margin-top:10px; max-width: 80vw; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    #ocr-output { display: none; margin-top: 10px; font-family: monospace; color: #333; }
    .sample-area img { max-width: min(400px, 80vw); margin: 5px; border: 1px solid #ccc; border-radius:6px; cursor:pointer; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .overlay img { max-width: 90vw; max-height: 90vh; border-radius:8px; box-shadow:0 0 10px #000; }
    .overlay.active { visibility: visible; opacity: 1; }
    @media (max-width: 768px), (hover: none) and (pointer: coarse) { body { font-size: 18px; } .drop-zone { display:none; } }
  </style>
</head>
<body>
  <h1 data-i18n="title">ELDEN RING NIGHTREIGN éºç‰©ç”»åƒçµåˆãƒ„ãƒ¼ãƒ«</h1>
  <div style="margin-bottom: 1rem;">
    <span style="margin-right: 8px;">Language:</span>
    <input type="radio" id="lang-ja" name="langSelect" value="ja" checked>
    <label for="lang-ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</label>
    <input type="radio" id="lang-en" name="langSelect" value="en">
    <label for="lang-en">ğŸ‡ºğŸ‡¸ English</label>
  </div>
  <p style="margin: 0" data-i18n="desc">1ã€œ3æ ã€4ã€œ6æ ã®éºç‰©åŠ¹æœç”»åƒã‚’1æšã«ã¾ã¨ã‚ã¾ã™ã€‚çµåˆã—ãŸã„éºç‰©å„€å¼ã®ç”»åƒ2æšã€ã‚‚ã—ãã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã®ç”»åƒ2æšã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  <!-- æ³¨æ„äº‹é … -->
  <details style="margin:10px 0;">
    <summary style="cursor: pointer; color:#007bff;" data-i18n="noteSummary">æ³¨æ„äº‹é … (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹)</summary>
    <ul style="color:#555; font-size: 0.9rem; margin: 0.25rem 0 1rem; padding-inline-start: 30px;">
      <li data-i18n="note1">ç”»åƒã¯ãã‚Œãã‚Œ1ã€œ3æ ã€4ã€œ6æ ã®éºç‰©åŠ¹æœãŒå†™ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>
      <li data-i18n="note2">åº§æ¨™æŒ‡å®šã§åˆ‡ã‚ŠæŠœã„ã¦ã„ã‚‹ãŸã‚ç”»åƒã‚µã‚¤ã‚ºãªã©ã®è¦å› ã§æ­£å¸¸ã«çµåˆã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
      <li data-i18n="note3">é¸æŠã§ãã‚‹ç”»åƒã¯2æšã¾ã§ã§ã™ã€‚ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§2æšä»¥ä¸Šé¸æŠã—ãŸå ´åˆã¯å…ˆé ­ã®2æšãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</li>
      <li data-i18n="note4">é¸æŠã—ãŸç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‡¦ç†ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</li>
      <li data-i18n="note5" data-i18n-html>æ–‡å­—èªè­˜(OCR)æ©Ÿèƒ½ã¯Î²ç‰ˆã§ã™ã€‚<a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚èªè­˜ç²¾åº¦ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚</li>
      <li data-i18n="note6">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯éå…¬å¼ã®ã‚‚ã®ã§ã‚ã‚Šã€ELDEN RING NIGHTREIGNã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
      <li data-i18n="note7" data-i18n-html>ãªã«ã‹ã‚ã‚Œã° <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚å¯èƒ½ãªç¯„å›²ã§å¯¾å¿œã—ã¾ã™ã€‚ã™ã§ã«<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">é¡ä¼¼ã® Issue ãŒç„¡ã„ã‹ã‚’äº‹å‰ç¢ºèª</a>ã—ãŸã†ãˆã§ã”é€£çµ¡é ‚ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™</li>
    </ul>
  </details>

  <!-- ç”»é¢ã‚¿ã‚¤ãƒ—é¸æŠ -->
  <div class="pattern-block" style="margin-bottom: 0.5rem">
    <fieldset>
      <legend data-i18n="patternSelect">ç”»é¢ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</legend>
      <input type="radio" name="pattern" id="pattern-ritual" value="ritual" checked><label for="pattern-ritual" data-i18n="patternRitual">éºç‰©å„€å¼ç”»é¢ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</label><br>
      <input type="radio" name="pattern" id="pattern-status" value="status"><label for="pattern-status" data-i18n="patternStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢</label>
    </fieldset>
  </div>

  <div class="input-area">
    <div class="file-block">
      <h3 data-i18n="relic1_3">éºç‰©1ã€œ3</h3>
      <input type="file" id="file1" accept="image/*">
      <img id="preview1" class="preview" style="display:none;">
    </div>
    <div class="file-block">
      <h3 data-i18n="relic4_6">éºç‰©4ã€œ6</h3>
      <input type="file" id="file2" accept="image/*">
      <img id="preview2" class="preview" style="display:none;">
    </div>
  </div>

  <div class="drop-zone" id="drop-zone" data-i18n="dropHere">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãã¾ã™ (2æš)</div>

  <button id="swap" data-i18n="swap">ç”»åƒå…¥ã‚Œæ›¿ãˆ</button>
  <button id="generate" disabled data-i18n="generate">ç”Ÿæˆ</button>
  <button id="reset" data-i18n="reset">ãƒªã‚»ãƒƒãƒˆ</button>

  <div id="output">
    <h2 style="margin-bottom: 0" data-i18n="result">å‡ºåŠ›çµæœ</h2>
    <div>
      <a id="download" data-i18n="download">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
      <button id="copy" data-i18n="copy">ã‚³ãƒ”ãƒ¼</button>
    </div>
    <canvas id="canvas"></canvas>
    <img id="output-img" alt="çµåˆçµæœ">
  </div>

  <div id="ocr-output">
    <h3 data-i18n="ocrTitle">æ–‡å­—æŠ½å‡ºçµæœ(Î²ç‰ˆ)</h3>
    <h4 data-i18n="relic1_3">éºç‰©1ã€œ3</h4>
    <div id="ocr-output-inner1" style="white-space: pre-wrap;"></div>
    <h4 data-i18n="relic4_6">éºç‰©4ã€œ6</h4>
    <div id="ocr-output-inner2" style="white-space: pre-wrap;"></div>
  </div>

  <h2 data-i18n="sample">ã‚µãƒ³ãƒ—ãƒ«</h2>
  <div class="sample-area">
    <h3 data-i18n="pattern1">ãƒ‘ã‚¿ãƒ¼ãƒ³1(éºç‰©å„€å¼ç”»é¢)</h3>
    <div class="sample-pattern1">
      <p data-i18n="inputExample">å…¥åŠ›ä¾‹:</p>
      <img src="images/sample_a1_1-3.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_a1">
      <img src="images/sample_a2_4-6.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_a2">
      <p data-i18n="outputExample">å‡ºåŠ›ä¾‹:</p>
      <img src="images/sample_a3_1-6.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_a3_çµåˆçµæœ">
    </div>
    <h3 data-i18n="pattern2">ãƒ‘ã‚¿ãƒ¼ãƒ³2(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢)</h3>
    <div class="sample-pattern2">
      <p data-i18n="inputExample">å…¥åŠ›ä¾‹:</p>
      <img src="images/sample_b1_1-3.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_b1">
      <img src="images/sample_b2_4-6.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_b2">
      <p data-i18n="outputExample">å‡ºåŠ›ä¾‹:</p>
      <img src="images/sample_b3_1-6.jpg" alt="ã‚µãƒ³ãƒ—ãƒ«_b3_çµåˆçµæœ">
    </div>
  </div>

  <div class="overlay" id="overlay">
    <img id="overlay-img" src="">
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    /********************
     * å¤šè¨€èªè¾æ›¸
     ********************/
    const i18n = {
      ja: {
        alertBothFramesFilled: "æ—¢ã«ä¸¡æ–¹ã®æ ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™ã€‚2æšã¾ã¨ã‚ã¦ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚",
        alertCopyError: "ã‚³ãƒ”ãƒ¼å¤±æ•—: ",
        alertCopySuccess: "ç”»åƒã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼",
        alertSelectTwoImages: "ç”»åƒã‚’2æšé¸æŠã—ã¦ãã ã•ã„",
        copy: "ã‚³ãƒ”ãƒ¼",
        desc: "1ã€œ3æ ã€4ã€œ6æ ã®éºç‰©åŠ¹æœç”»åƒã‚’1æšã«ã¾ã¨ã‚ã¾ã™ã€‚çµåˆã—ãŸã„éºç‰©å„€å¼ã®ç”»åƒ2æšã€ã‚‚ã—ãã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã®ç”»åƒ2æšã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
        download: "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        dropHere: "ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãã¾ã™ (2æš)",
        errorOCRFailed: "OCRã«å¤±æ•—: ",
        generate: "ç”Ÿæˆ",
        inputExample: "å…¥åŠ›ä¾‹:",
        longTap: "ç”»åƒã® ã‚³ãƒ”ãƒ¼/ä¿å­˜/etc ã‚’ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ç”»åƒã‚’ãƒ­ãƒ³ã‚°ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚",
        note1: "ç”»åƒã¯ãã‚Œãã‚Œ1ã€œ3æ ã€4ã€œ6æ ã®éºç‰©åŠ¹æœãŒå†™ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
        note2: "åº§æ¨™æŒ‡å®šã§åˆ‡ã‚ŠæŠœã„ã¦ã„ã‚‹ãŸã‚ç”»åƒã‚µã‚¤ã‚ºãªã©ã®è¦å› ã§æ­£å¸¸ã«çµåˆã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚",
        note3: "é¸æŠã§ãã‚‹ç”»åƒã¯2æšã¾ã§ã§ã™ã€‚ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§2æšä»¥ä¸Šé¸æŠã—ãŸå ´åˆã¯å…ˆé ­ã®2æšãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚",
        note4: "é¸æŠã—ãŸç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‡¦ç†ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚",
        note5: `æ–‡å­—èªè­˜(OCR)æ©Ÿèƒ½ã¯Î²ç‰ˆã§ã™ã€‚<a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚èªè­˜ç²¾åº¦ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚`,
        note6: "ã“ã®ãƒ„ãƒ¼ãƒ«ã¯éå…¬å¼ã®ã‚‚ã®ã§ã‚ã‚Šã€ELDEN RING NIGHTREIGNã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚",
        note7: `ãªã«ã‹ã‚ã‚Œã° <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚å¯èƒ½ãªç¯„å›²ã§å¯¾å¿œã—ã¾ã™ã€‚ã™ã§ã«<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">é¡ä¼¼ã® Issue ãŒç„¡ã„ã‹ã‚’äº‹å‰ç¢ºèª</a>ã—ãŸã†ãˆã§ã”é€£çµ¡é ‚ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™`,
        noteSummary: "æ³¨æ„äº‹é … (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹)",
        ocrProcessing: "OCR èª­ã¿å–ã‚Šä¸­â€¦",
        ocrTitle: "æ–‡å­—æŠ½å‡ºçµæœ(Î²ç‰ˆ)",
        outputExample: "å‡ºåŠ›ä¾‹:",
        pattern1: "ãƒ‘ã‚¿ãƒ¼ãƒ³1(éºç‰©å„€å¼ç”»é¢)",
        pattern2: "ãƒ‘ã‚¿ãƒ¼ãƒ³2(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢)",
        patternRitual: "éºç‰©å„€å¼ç”»é¢ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)",
        patternSelect: "ç”»é¢ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ",
        patternStatus: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢",
        progress: "å‡¦ç†ä¸­...",
        relic1_3: "éºç‰©1ã€œ3",
        relic4_6: "éºç‰©4ã€œ6",
        reset: "ãƒªã‚»ãƒƒãƒˆ",
        result: "å‡ºåŠ›çµæœ",
        sample: "ã‚µãƒ³ãƒ—ãƒ«",
        swap: "ç”»åƒå…¥ã‚Œæ›¿ãˆ",
        title: "ELDEN RING NIGHTREIGN éºç‰©ç”»åƒçµåˆãƒ„ãƒ¼ãƒ«",
      },
      en: {
        alertBothFramesFilled: "Both frames are already filled. Please drag and drop two images at once or reset and try again.",
        alertCopyError: "Copy failed: ",
        alertCopySuccess: "Image copied to clipboard!",
        alertSelectTwoImages: "Please select two images",
        copy: "Copy",
        desc: "Combine relic effect images of slots 1â€“3 and 4â€“6 into one image. Please select two images from the relic rites screen or the status screen that you want to combine.",
        download: "Download",
        dropHere: "Drag & Drop images here (2 images)",
        errorOCRFailed: "OCR failed: ",
        generate: "Generate",
        inputExample: "Input Example:",
        longTap: "Long-press the image to copy/save/etc.",
        note1: "Each image must show the relic effects for slots 1â€“3 and 4â€“6.",
        note2: "Due to the cropping method used, images may not combine correctly depending on their size and other factors.",
        note3: "You can select up to 2 images. If you select more than 2 images via drag & drop, only the first 2 will be used.",
        note4: "The selected images are processed in the browser and are not sent to the server.",
        note5: `The OCR feature is in beta. It uses <a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>. Recognition accuracy is not guaranteed.`,
        note6: "This tool is unofficial and is not affiliated with ELDEN RING NIGHTREIGN.",
        note7: `If you have any questions, please contact us via <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>. We will respond as much as possible. It would be helpful if you could check for <a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">similar issues</a> beforehand.`,
        noteSummary: "Notes (Click to Expand)",
        ocrProcessing: "OCR Processing...",
        ocrTitle: "OCR Results (Beta)",
        outputExample: "Output Example:",
        pattern1: "Pattern 1 (Relic Rites Screen)",
        pattern2: "Pattern 2 (Status Screen)",
        patternRitual: "Relic Rites Screen (Default)",
        patternSelect: "Select Screen Type",
        patternStatus: "Status Screen",
        progress: "Processing...",
        relic1_3: "Relics 1â€“3",
        relic4_6: "Relics 4â€“6",
        reset: "Reset",
        result: "Result",
        sample: "Examples",
        swap: "Swap Images",
        title: "ELDEN RING NIGHTREIGN Relic Image Merger",
      }
    };

    function applyLang(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[lang] && i18n[lang][key]) {
          if (el.dataset.i18nHtml !== undefined) {
            el.innerHTML = i18n[lang][key];
          } else {
            el.textContent = i18n[lang][key];
          }
        }
      });
      localStorage.setItem("lang", lang);
    }

    function t(key) {
      const lang = localStorage.getItem("lang") || "ja";
      return (i18n[lang] && i18n[lang][key]) || key;
    }

    /********************
     * è¨€èªåˆæœŸåŒ–
     ********************/
    const savedLang = localStorage.getItem("lang") || "ja";
    document.querySelector("input[name='langSelect'][value='" + savedLang + "']").checked = true;
    applyLang(savedLang);

    document.querySelectorAll("input[name='langSelect']").forEach(radio => {
      radio.addEventListener("change", e => {
        applyLang(e.target.value);
      });
    });

    /********************
     * ãƒ¡ã‚¤ãƒ³å‡¦ç†
     ********************/
    const file1Input = document.getElementById("file1");
    const file2Input = document.getElementById("file2");
    const swapBtn = document.getElementById("swap");
    const generateBtn = document.getElementById("generate");
    const resetBtn = document.getElementById("reset");
    const copyBtn = document.getElementById("copy");
    const downloadLink = document.getElementById("download");
    const ocrOutputDiv = document.getElementById("ocr-output");
    const ocrInner1 = document.getElementById("ocr-output-inner1");
    const ocrInner2 = document.getElementById("ocr-output-inner2");
    const outputDiv = document.getElementById("output");
    const outputImg = document.getElementById("output-img");

    let replaceRules = {};

    // å¤–éƒ¨ç½®æ›ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
    async function loadReplaceRules() {
      try {
        const res = await fetch('./replace_rules.json');
        replaceRules = await res.json();
      } catch(e){ console.warn("ç½®æ›ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—",e); replaceRules={}; }
    }
    loadReplaceRules();

    // ç”»é¢ã‚¿ã‚¤ãƒ—é¸æŠ
    let selectedPattern = "ritual";
    document.querySelectorAll('input[name="pattern"]').forEach(radio=>{
      radio.addEventListener("change",e=>selectedPattern=e.target.value);
    });

    async function loadImage(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>resolve(img);
          img.src=e.target.result;
        };
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function setPreview(file, previewId){
      const reader=new FileReader();
      reader.onload=e=>{
        const img=document.getElementById(previewId);
        img.src=e.target.result; img.style.display="block";
      };
      reader.readAsDataURL(file);
    }

    function updateGenerateButton(){
      generateBtn.disabled = !(file1Input.files[0] && file2Input.files[0]);
    }

    file1Input.addEventListener("change",()=>{ setPreview(file1Input.files[0],"preview1"); updateGenerateButton(); });
    file2Input.addEventListener("change",()=>{ setPreview(file2Input.files[0],"preview2"); updateGenerateButton(); });
    updateGenerateButton();

    swapBtn.addEventListener("click", () => {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¥ã‚Œæ›¿ãˆ
      const tempFiles = file1Input.files;
      file1Input.files = file2Input.files;
      file2Input.files = tempFiles;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚å…¥ã‚Œæ›¿ãˆ
      const tempSrc = document.getElementById("preview1").src;
      document.getElementById("preview1").src = document.getElementById("preview2").src;
      document.getElementById("preview2").src = tempSrc;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
      document.getElementById("preview1").style.display = file1Input.files[0] ? "block" : "none";
      document.getElementById("preview2").style.display = file2Input.files[0] ? "block" : "none";

      // ç”Ÿæˆãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
      updateGenerateButton();
    });

    resetBtn.addEventListener("click",()=>{
      file1Input.value=""; file2Input.value="";
      outputDiv.style.display="none";
      document.querySelectorAll("#preview1, #preview2, #output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
      ocrOutputDiv.style.display="none";
      document.querySelectorAll("#ocr-output-inner1, #ocr-output-inner2").forEach(div=>{ div.textContent=""; });
      document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
      document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
      updateGenerateButton();
    });

    async function preprocessImage(file){
      const img = await loadImage(file);
      const canvas=document.createElement("canvas");
      canvas.width=img.width; canvas.height=img.height;
      const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      const data=imageData.data;
      for(let i=0;i<data.length;i+=4){
        const avg=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
        data[i]=data[i+1]=data[i+2]=avg;
      }
      ctx.putImageData(imageData,0,0);
      const scaled=document.createElement("canvas"); scaled.width=canvas.width*2; scaled.height=canvas.height*2;
      scaled.getContext("2d").drawImage(canvas,0,0,scaled.width,scaled.height);
      return scaled;
    }

    function getOcrCropBox(img) {
      if(selectedPattern==="ritual"){
        return { x: img.width*0.075, y: img.height*0.385, w: img.width*(0.325-0.075), h: img.height*(0.925-0.385) };
      } else {
        return { x: img.width*0.425, y: img.height*0.27, w: img.width*0.325, h: img.height*0.58 };
      }
    }

    async function runOCR(file, outputDiv){
      const processed = await preprocessImage(file);
      const { x: cropX, y: cropY, w: cropW, h: cropH } = getOcrCropBox(processed);
      const cropCanvas=document.createElement("canvas"); cropCanvas.width=cropW; cropCanvas.height=cropH;
      cropCanvas.getContext("2d").drawImage(processed,cropX,cropY,cropW,cropH,0,0,cropW,cropH);

      const { data:{ text } } = await Tesseract.recognize(cropCanvas,'jpn',{
        logger:m=>{ if(m.status==='recognizing text') outputDiv.textContent=`${t("ocrProcessing")} ${Math.floor(m.progress*100)}%`; }
      });

      const lines=text.split('\n').map(l=>l.replace(/\s+/g,''));
      const replaced=lines.map(l=>{
        let s=l;
        for(const key in replaceRules){ s=s.split(key).join(replaceRules[key]); }
        return s;
      });
      return replaced.join('\n');
    }

    function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
    copyBtn.onclick=async()=>{
      const canvas=document.getElementById("canvas");
      canvas.toBlob(async blob=>{
        try{ await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]); alert(t("alertCopySuccess")); }
        catch(e){ alert(t("alertCopyError")+e);}
      },"image/png");
    };

    function getCropBox(img) {
      if(selectedPattern==="ritual"){
        return { x: img.width*0.05, y: img.height*0.1125, w: img.width*0.325, h: img.height*0.8125 };
      } else {
        return { x: img.width*0.35, y: img.height*0.27, w: img.width*0.40, h: img.height*0.58 };
      }
    }

    generateBtn.addEventListener("click",async()=>{
      const file1=file1Input.files[0], file2=file2Input.files[0];
      if(!file1||!file2){ alert(t("alertSelectTwoImages")); return; }

      const img1=await loadImage(file1); const img2=await loadImage(file2);
      const crop1=getCropBox(img1);
      const crop2=getCropBox(img2);

      const canvas=document.getElementById("canvas"); canvas.width=crop1.w+crop2.w; canvas.height=Math.max(crop1.h,crop2.h);
      const ctx=canvas.getContext("2d");
      ctx.drawImage(img1,crop1.x,crop1.y,crop1.w,crop1.h,0,0,crop1.w,crop1.h);
      ctx.drawImage(img2,crop2.x,crop2.y,crop2.w,crop2.h,crop1.w,0,crop2.w,crop2.h);

      const dataUrl=canvas.toDataURL("image/jpeg");
      outputImg.src=dataUrl;
      outputImg.style.display="block";
      outputDiv.style.display="block";

      const now=new Date();
      downloadLink.href=dataUrl;
      downloadLink.download=`enr_merged_relics_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}.jpg`;
      downloadLink.style.display="inline-block";

      if(isiOS()){
        const infoText = document.createElement("p");
        infoText.textContent = t("longTap");
        infoText.style.color="#555";
        infoText.style.margin="0";
        infoText.classList.add("ios-copy-info");
        copyBtn.parentNode.insertBefore(infoText, copyBtn.nextSibling);
      } else {
        copyBtn.style.display="inline-block";
        document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
      }

      ocrOutputDiv.style.display="block";
      try{
        ocrInner1.textContent = await runOCR(file1,ocrInner1);
        ocrInner2.textContent = await runOCR(file2,ocrInner2);
      }catch(e){ ocrOutputDiv.textContent=t("errorOCRFailed")+e; }
    });

    const dropZone=document.getElementById("drop-zone");
    dropZone.addEventListener("dragover",e=>{ e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave",()=>{ dropZone.classList.remove("dragover"); });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");

      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
      if(files.length === 0) return;

      // 1æšãƒ‰ãƒ­ãƒƒãƒ—
      if(files.length === 1){
        if(!file1Input.files[0]){
          const dt1 = new DataTransfer();
          dt1.items.add(files[0]);
          file1Input.files = dt1.files;
          setPreview(files[0], "preview1");
        } else if(!file2Input.files[0]){
          const dt2 = new DataTransfer();
          dt2.items.add(files[0]);
          file2Input.files = dt2.files;
          setPreview(files[0], "preview2");
        } else {
          alert(t("alertBothFramesFilled"));
        }
      }
      // 2æšä»¥ä¸Šãƒ‰ãƒ­ãƒƒãƒ— â†’ ç·å…¥ã‚Œæ›¿ãˆ
      else {
        const dt1 = new DataTransfer();
        const dt2 = new DataTransfer();
        dt1.items.add(files[0]);
        dt2.items.add(files[1]);
        file1Input.files = dt1.files;
        file2Input.files = dt2.files;
        setPreview(files[0], "preview1");
        setPreview(files[1], "preview2");
      }

      updateGenerateButton();
    });

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    function enableOverlay(selector) {
      document.querySelectorAll(selector).forEach(img => {
        img.addEventListener("click", () => {
          const overlay = document.getElementById("overlay");
          const overlayImg = document.getElementById("overlay-img");
          overlayImg.src = img.src;
          overlay.classList.add("active");
        });
      });
    }
    enableOverlay("#preview1, #preview2, #output-img, .sample-area img");
    const overlay=document.getElementById("overlay");
    overlay.addEventListener("click",()=>overlay.classList.remove("active"));
  </script>
</body>
</html>
