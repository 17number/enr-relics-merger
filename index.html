<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">ELDEN RING NIGHTREIGN 遺物画像結合ツール</title>
  <meta name="description" content="ELDEN RING NIGHTREIGN(ナイトレイン)の遺物(1〜3枠)、深き夜の深層遺物(4〜6枠)の遺物効果画像を1枚にまとめるツール / Tool for merging relic effect images from ELDEN RING NIGHTREIGN (relic 1-3 slots, deep of night depth relic 4-6 slots) into a single image">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="ELDEN RING NIGHTREIGN,ナイトレイン,NIGHTREIGN,深き夜,Deep of Night,遺物,深層遺物,Relic,Relics,Depth Relic,画像結合,Image Merger">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://17number.github.io/enr-relics-merger/">
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; background: #f8f9fa; color:#333; font-size: 16px; }
    h1 { font-size: 1.4rem; }
    .input-area { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .pattern-block input[type="radio"], .pattern-block label { cursor: pointer; }
    .file-block { flex: 1; min-width: 200px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px dashed #999; }
    .file-block h3 { margin: 0 0 8px; font-size: 1rem; }
    .preview { display:block; max-width: min(400px, 80vw); max-height: 400px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    .drop-zone { border: 2px dashed #999; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center; color: #666; background:#fff; }
    .drop-zone.dragover { border-color: #3399ff; background: #3399ff33; }
    button, a { font-family: "Segoe UI", sans-serif; margin: 10px 5px 20px 0; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px; cursor: pointer; }
    #swap { background:#3399ff; color:#fff; }
    #reset, #reset1, #reset2 { background:#dc3545; color:#fff; }
    #reset1, #reset2 { padding: 5px 10px; font-size: 0.85rem; margin-bottom: 0; }
    #add-text-qr, label[for="add-text-qr"] { cursor: pointer; }
    #result-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
      align-items: center;
    }
    #result-buttons > button,
    #result-buttons > a,
    #result-buttons > input {
      flex: 0 0 auto;
      min-width: auto;
    }
    #result-buttons > input {
      width: 250px;
      height: 2rem;
      box-sizing: border-box;
    }
    @media (max-width: 500px) {
      #result-buttons > * {
        flex: 0 0 calc(50% - 10px);
      }
      #result-buttons > #ios-copy-info {
        flex: 0 0 85vw;
      }
    }
    #download { background:#28a745; color:#fff; display:none; text-decoration:none; }
    #copy { background:#17a2b8; color:#fff; display:none; }
    #canvas { display:none; }
    #output { display:none; }
    #output-img { margin-top:10px; max-width: 80vw; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    .sample-area img { max-width: min(400px, 80vw); margin: 5px; border: 1px solid #ccc; border-radius:6px; cursor:pointer; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .overlay img { max-width: 90vw; max-height: 90vh; border-radius:8px; box-shadow:0 0 10px #000; }
    .overlay.active { visibility: visible; opacity: 1; }

    /* トースト通知 */
    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      /* transform: translateX(-50%); */
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 10000;
    }

    @media (max-width: 768px), (hover: none) and (pointer: coarse) { body { font-size: 18px; } .drop-zone { display:none; } }
  </style>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ENR Relics Merger",
      "url": "https://17number.github.io/enr-relics-merger/",
      "applicationCategory": "Game",
      "operatingSystem": "Web",
      "description": "ELDEN RING NIGHTREIGN の遺物画像を結合する簡単なウェブツール。",
      "image": "https://17number.github.io/enr-relics-merger/images/sample_a3_1-6.jpg"
    }
  </script>
  <meta name="google-site-verification" content="yr6qjqaE9dOm6wsDFdWNKrCc6EJAmBnvMaDcQ0ILT8w" />
</head>
<body>
  <h1 data-i18n="title">ELDEN RING NIGHTREIGN 遺物画像結合ツール</h1>
  <div style="margin-bottom: 1rem;">
    <span>Language:</span>
    <input type="radio" id="lang-ja" name="langSelect" value="ja" checked>
    <label for="lang-ja">🇯🇵 日本語</label>
    <input type="radio" id="lang-en" name="langSelect" value="en">
    <label for="lang-en">🇺🇸 English</label>
  </div>
  <p style="margin: 0" data-i18n="desc" data-i18n-html>遺物(1〜3枠)、深き夜の深層遺物(4〜6枠)の遺物効果画像を1枚にまとめます。結合したい 遺物儀式の画像/ステータス画面の画像/プリセット画面の画像 を2枚選択してください。ドラッグ＆ドロップ、画像データのペースト(Win: Ctrl+v, Mac: ⌘+v)も可能です。(<a href="#sample" style="padding: 0; margin: 0;">サンプル</a>)</p>
  <p style="margin: 0" data-i18n="desc2" data-i18n-html><a href="https://x.com/" target="_blank" style="padding: 0; margin: 0;">X</a> や <a href="https://discord.com/" target="_blank" style="padding: 0; margin: 0;">Discord</a> などで共有してもらえると嬉しいです。</p>
  <!-- 注意事項 -->
  <details style="margin:10px 0;">
    <summary style="cursor: pointer; color:#007bff;" data-i18n="noteSummary">注意事項 (クリックで展開)</summary>
    <ul style="color:#555; font-size: 0.9rem; margin: 0.25rem 0 1rem; padding-inline-start: 30px;">
      <li data-i18n="note1">画像はそれぞれ1〜3枠、4〜6枠の遺物効果が写っている必要があります。</li>
      <li data-i18n="note2">座標指定で切り抜いているため画像サイズなどの要因で正常に結合できない場合があります。</li>
      <li data-i18n="note3">選択できる画像は2枚までです。ドラッグ＆ドロップで2枚以上選択した場合は先頭の2枚が使用されます。</li>
      <li data-i18n="note4">選択した画像はブラウザ上で処理され、サーバーには送信されません。</li>
      <li data-i18n="note6">このツールは非公式のものであり、ELDEN RING NIGHTREIGNとは関係ありません。</li>
      <li data-i18n="note7" data-i18n-html>なにかあれば <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0; margin: 0;">Issues</a>からご連絡ください。可能な範囲で対応します。すでに<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0; margin: 0;">類似の Issue が無いかを事前確認</a>したうえでご連絡頂けると助かります</li>
    </ul>
  </details>

  <h2 data-i18n="mergeSettings">結合画像設定</h2>

  <div class="drop-zone" id="drop-zone" data-i18n="dropHere">ここに画像をドラッグ＆ドロップできます (2枚)</div>

  <div class="input-area">
    <div class="file-block" id="file-block1">
      <h3 data-i18n="relic1_3">遺物1〜3</h3>
      <input type="file" id="file1" accept="image/*">
      <img id="preview1" class="preview" alt="プレビュー1" style="display:none;">
      <button id="reset1" data-i18n="reset" style="display: none;">リセット</button>
    </div>
    <div class="file-block" id="file-block2">
      <h3 data-i18n="relic4_6">遺物4〜6</h3>
      <input type="file" id="file2" accept="image/*">
      <img id="preview2" class="preview" alt="プレビュー2" style="display:none;">
      <button id="reset2" data-i18n="reset" style="display: none;">リセット</button>
    </div>
  </div>

  <!-- 画面タイプ選択 -->
  <div class="pattern-block" style="margin-bottom: 0.5rem">
    <fieldset>
      <legend data-i18n="patternSelect">画面タイプ</legend>
      <input type="radio" name="pattern" id="pattern-ritual" value="ritual" checked><label for="pattern-ritual" data-i18n="patternRitual">遺物儀式画面</label><br>
      <input type="radio" name="pattern" id="pattern-status" value="status"><label for="pattern-status" data-i18n="patternStatus">ステータス画面</label><br>
      <input type="radio" name="pattern" id="pattern-preset" value="preset"><label for="pattern-preset" data-i18n="patternPreset">プリセット画面</label>
    </fieldset>
  </div>

  <button id="swap" data-i18n="swap">画像入れ替え</button>
  <button id="reset" data-i18n="reset">リセット</button>
  <div style="display: inline-block;">
    <input type="checkbox" id="add-text-qr" checked>
    <label for="add-text-qr" data-i18n="qrEmbed">Generated By/QRコード 埋め込み</label>
  </div>

  <div id="output">
    <h2 style="margin-bottom: 0" data-i18n="result">出力結果</h2>
    <div id="result-buttons">
      <button id="copy" data-i18n="copy">コピー</button>
      <a id="download" data-i18n="download">ダウンロード</a>
      <input type="text" id="download_name" placeholder="ダウンロードファイル名 (省略可)" data-i18n="download_name" data-i18n-placeholder>
      <a href="https://twitter.com/intent/tweet?text=Generated by&url=https://17number.github.io/enr-relics-merger/"
        class="twitter-share-button"
        data-show-count="false">
        Post on X
      </a>
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
    <canvas id="canvas"></canvas>
    <img id="output-img" alt="結合結果">
  </div>

  <h2 id="sample" data-i18n="sample">サンプル</h2>
  <div class="sample-area">
    <h3 data-i18n="pattern1">パターン1(遺物儀式画面)</h3>
    <div class="sample-pattern1">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_a1_1-3.jpg" alt="サンプル_a1" loading="lazy">
      <img src="images/sample_a2_4-6.jpg" alt="サンプル_a2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_a3_1-6.jpg" alt="サンプル_a3_結合結果" loading="lazy">
    </div>
    <h3 data-i18n="pattern2">パターン2(ステータス画面)</h3>
    <div class="sample-pattern2">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_b1_1-3.jpg" alt="サンプル_b1" loading="lazy">
      <img src="images/sample_b2_4-6.jpg" alt="サンプル_b2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_b3_1-6.jpg" alt="サンプル_b3_結合結果" loading="lazy">
    </div>
    <h3 data-i18n="pattern3">パターン3(プリセット画面)</h3>
    <div class="sample-pattern3">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_c1_1-3.jpg" alt="サンプル_c1" loading="lazy">
      <img src="images/sample_c2_4-6.jpg" alt="サンプル_c2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_c3_1-6.jpg" alt="サンプル_c3_結合結果" loading="lazy">
    </div>
  </div>

  <!-- バージョン情報表示エリア -->
  <div id="version" style="font-size: 0.9em; color: #666; margin-top: 1rem; text-align: center;"></div>

  <div class="overlay" id="overlay">
    <img id="overlay-img" src="" alt="拡大表示">
  </div>

  <!-- トースト通知 -->
  <div id="toast"></div>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BN1ZV55K0M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BN1ZV55K0M');
  </script>

  <!-- QRコード -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@2.0.4/dist/qrcode.min.js"></script>

  <script>
    /********************
     * 多言語辞書
     ********************/
    const i18n = {
      ja: {
        alertBothFramesFilled: "既に両方の枠が埋まっています。2枚まとめてドラッグ＆ドロップするか、リセットしてやり直してください。",
        alertBothFramesFilledForPaste: "既に両方の枠が埋まっています。リセットしてやり直してください。",
        alertCopyError: "コピー失敗: ",
        alertCopySuccess: "画像をクリップボードにコピーしました",
        alertGenerateSuccess: "結合画像を生成しました",
        alertSelectTwoImages: "2枚目の画像を選択してください",
        copy: "コピー",
        desc: `遺物(1〜3枠)、深き夜の深層遺物(4〜6枠)の遺物効果画像を1枚にまとめます。結合したい 遺物儀式の画像/ステータス画面の画像/プリセット画面の画像 を2枚選択してください。ドラッグ＆ドロップ、画像データのペースト(Win: Ctrl+v, Mac: ⌘+v)も可能です。(<a href="#sample" style="padding: 0; margin: 0;">サンプル</a>)`,
        desc2: `<a href="https://x.com/" target="_blank" style="padding: 0; margin: 0;">X</a> や <a href="https://discord.com/" target="_blank" style="padding: 0; margin: 0;">Discord</a> などで共有してもらえると嬉しいです。`,
        download: "ダウンロード",
        download_name: "ダウンロードファイル名 (省略可)",
        dropHere: "ここに画像をドラッグ＆ドロップできます (2枚)",
        generatedBy: "Generated by ELDEN RING NIGHTREIGN 遺物画像結合ツール",
        inputExample: "入力例:",
        longTap: "画像の コピー/保存/etc をしたい場合は以下画像をロングタップしてください。",
        longTapOrRightClick: "画像の コピー/保存/etc をしたい場合は以下画像をロングタップ(または右クリック)してください。",
        mergeSettings: "結合画像設定",
        note1: "画像はそれぞれ1〜3枠、4〜6枠の遺物効果が写っている必要があります。",
        note2: "座標指定で切り抜いているため画像サイズなどの要因で正常に結合できない場合があります。",
        note3: "選択できる画像は2枚までです。ドラッグ＆ドロップで2枚以上選択した場合は先頭の2枚が使用されます。",
        note4: "選択した画像はブラウザ上で処理され、サーバーには送信されません。",
        note6: "このツールは非公式のものであり、ELDEN RING NIGHTREIGNとは関係ありません。",
        note7: `なにかあれば <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0; margin: 0;">Issues</a>からご連絡ください。可能な範囲で対応します。すでに<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0; margin: 0;">類似の Issue が無いかを事前確認</a>したうえでご連絡頂けると助かります`,
        noteSummary: "注意事項 (クリックで展開)",
        outputExample: "出力例:",
        pattern1: "パターン1(遺物儀式画面)",
        pattern2: "パターン2(ステータス画面)",
        pattern3: "パターン3(プリセット画面)",
        patternPreset: "プリセット画面",
        patternRitual: "遺物儀式画面",
        patternSelect: "画面タイプ",
        patternStatus: "ステータス画面",
        progress: "処理中...",
        qrEmbed: "Generated By/QRコード 埋め込み",
        relic1_3: "遺物1〜3",
        relic4_6: "遺物4〜6",
        reset: "リセット",
        result: "出力結果",
        sample: "サンプル",
        swap: "画像入れ替え",
        title: "ELDEN RING NIGHTREIGN 遺物画像結合ツール",
      },
      en: {
        alertBothFramesFilled: "Both frames are already filled. Please drag and drop two images at once or reset and try again.",
        alertBothFramesFilledForPaste: "Both frames are already filled. Please reset and try again.",
        alertCopyError: "Copy failed: ",
        alertCopySuccess: "Image copied to clipboard",
        alertGenerateSuccess: "Combined image generated",
        alertSelectTwoImages: "Please select the second image",
        copy: "Copy",
        desc: `Combine relic effect images of relic(slots 1–3) and deep of night depth relic(slots 4–6) into one image. Please select two images from the relic rites screen or the status screen or the preset screen that you want to combine. Drag & drop and image data can also be pasted (Win: Ctrl+v, Mac: ⌘+v). (<a href="#sample" style="padding: 0; margin: 0;">Examples</a>)`,
        desc2: `It would be great if you could share it on <a href="https://x.com/" target="_blank" style="padding: 0; margin: 0;">X</a> or <a href="https://discord.com/" target="_blank" style="padding: 0; margin: 0;">Discord</a>.`,
        download: "Download",
        download_name: "Download File Name (Optional)",
        dropHere: "Drag & Drop images here (2 images)",
        generatedBy: "Generated by ELDEN RING NIGHTREIGN Relic Image Merger",
        inputExample: "Input Example:",
        longTap: "Long-press the image to copy/save/etc.",
        longTapOrRightClick: "Long-press or right-click the image to copy/save/etc.",
        mergeSettings: "Settings",
        note1: "Each image must show the relic effects for slots 1–3 and 4–6.",
        note2: "Due to the cropping method used, images may not combine correctly depending on their size and other factors.",
        note3: "You can select up to 2 images. If you select more than 2 images via drag & drop, only the first 2 will be used.",
        note4: "The selected images are processed in the browser and are not sent to the server.",
        note6: "This tool is unofficial and is not affiliated with ELDEN RING NIGHTREIGN.",
        note7: `If you have any questions, please contact us via <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0; margin: 0;">Issues</a>. We will respond as much as possible. It would be helpful if you could check for <a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0; margin: 0;">similar issues</a> beforehand.`,
        noteSummary: "Notes (Click to Expand)",
        outputExample: "Output Example:",
        pattern1: "Pattern 1 (Relic Rites Screen)",
        pattern2: "Pattern 2 (Status Screen)",
        pattern3: "Pattern 3 (Preset Screen)",
        patternPreset: "Preset Screen",
        patternRitual: "Relic Rites Screen",
        patternSelect: "Screen Type",
        patternStatus: "Status Screen",
        progress: "Processing...",
        qrEmbed: "With Generated By/QR Code",
        relic1_3: "Relics 1–3",
        relic4_6: "Relics 4–6",
        reset: "Reset",
        result: "Result",
        sample: "Examples",
        swap: "Swap Images",
        title: "ELDEN RING NIGHTREIGN Relic Image Merger",
      }
    };

    function applyLang(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[lang] && i18n[lang][key]) {
          if (el.dataset.i18nHtml !== undefined) {
            el.innerHTML = i18n[lang][key];
          } else if (el.dataset.i18nPlaceholder !== undefined) {
            el.placeholder = i18n[lang][key];
          } else {
            el.textContent = i18n[lang][key];
          }
        }
      });
      localStorage.setItem("lang", lang);
    }

    function t(key) {
      const lang = localStorage.getItem("lang") || "ja";
      return (i18n[lang] && i18n[lang][key]) || key;
    }

    /********************
     * 言語初期化
     ********************/
    const savedLang = localStorage.getItem("lang") || "ja";
    document.querySelector("input[name='langSelect'][value='" + savedLang + "']").checked = true;
    applyLang(savedLang);

    document.querySelectorAll("input[name='langSelect']").forEach(radio => {
      radio.addEventListener("change", e => {
        applyLang(e.target.value);
      });
    });

    /********************
     * トースト通知
     ********************/
    function showToast(message, type="info", duration=3000){
      const toast = document.getElementById("toast");
      toast.textContent = message;
      if(type==="error") toast.style.background="rgba(220,53,69,0.85)";
      else if(type==="success") toast.style.background="rgba(40,167,69,0.85)";
      else toast.style.background="rgba(0,0,0,0.85)";
      toast.style.opacity=1;
      toast.style.pointerEvents="auto";
      clearTimeout(toast._timeout);
      toast._timeout = setTimeout(()=>{
        toast.style.opacity=0;
        toast.style.pointerEvents="none";
      }, duration);
    }

    /********************
     * メイン処理
     ********************/
    const fileBlock1 = document.getElementById("file-block1");
    const fileBlock2 = document.getElementById("file-block2");
    const file1Input = document.getElementById("file1");
    const file2Input = document.getElementById("file2");
    const preview1 = document.getElementById("preview1");
    const preview2 = document.getElementById("preview2");
    const reset1 = document.getElementById("reset1");
    const reset2 = document.getElementById("reset2");
    const swapBtn = document.getElementById("swap");
    const resetBtn = document.getElementById("reset");
    const addTextQrCheckbox = document.getElementById("add-text-qr");
    const copyBtn = document.getElementById("copy");
    const downloadLink = document.getElementById("download");
    const downloadNameInput = document.getElementById("download_name");
    const outputDiv = document.getElementById("output");
    const outputImg = document.getElementById("output-img");

    // 画面タイプ選択
    let selectedPattern = "ritual";
    document.querySelectorAll('input[name="pattern"]').forEach(radio=>{
      radio.addEventListener("change",e=>{
        selectedPattern=e.target.value;
        generateMergedImage();
      });
    });

    addTextQrCheckbox.addEventListener("change", generateMergedImage);

    async function loadImage(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>resolve(img);
          img.src=e.target.result;
        };
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function setPreview(file, preview, reset){
      const reader=new FileReader();
      reader.onload=e=>{
        preview.src=e.target.result;
        preview.style.display="block";
        reset.style.display="inline-block";
      };
      reader.readAsDataURL(file);
    }

    file1Input.addEventListener("change",()=>{ setPreview(file1Input.files[0],preview1,reset1); generateMergedImage(); });
    file2Input.addEventListener("change",()=>{ setPreview(file2Input.files[0],preview2,reset2); generateMergedImage(); });

    /**
     * ペースト
     */
    document.addEventListener('paste', (e) => {
      const file1 = file1Input.files[0], file2 = file2Input.files[0];
      if(file1&&file2){
        showToast(t("alertBothFramesFilledForPaste"), "error");
        return;
      }

      const items = e.clipboardData.items;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if(!file1) {
            const dt = new DataTransfer();
            dt.items.add(file);
            file1Input.files = dt.files;
            setPreview(file1Input.files[0],preview1,reset1);
            generateMergedImage();
          } else if(!file2) {
            const dt = new DataTransfer();
            dt.items.add(file);
            file2Input.files = dt.files;
            setPreview(file2Input.files[0],preview2,reset2);
            generateMergedImage();
          }
        }
      }
    });

    swapBtn.addEventListener("click", () => {
      // ファイルオブジェクトを入れ替え
      const tempFiles = file1Input.files;
      file1Input.files = file2Input.files;
      file2Input.files = tempFiles;

      // プレビューも入れ替え
      const tempSrc = preview1.src;
      preview1.src = preview2.src;
      preview2.src = tempSrc;

      // プレビュー表示制御
      preview1.style.display = file1Input.files[0] ? "block" : "none";
      preview2.style.display = file2Input.files[0] ? "block" : "none";

      // リセットボタン表示制御
      reset1.style.display = file1Input.files[0] ? "inline-block" : "none";
      reset2.style.display = file2Input.files[0] ? "inline-block" : "none";

      generateMergedImage();
    });

    // 全体リセットボタン
    function handleReset(){
      file1Input.value=""; file2Input.value="";
      outputDiv.style.display="none";
      document.querySelectorAll("#preview1, #preview2, #output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
      document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
      document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
      document.querySelectorAll("#reset1, #reset2").forEach(btn=>{ btn.style.display="none"; });
    };
    resetBtn.addEventListener("click",handleReset);

    // 個別リセットボタン
    function handleResetIndividual(resetId, fileInputId, previewId){
      document.getElementById(fileInputId).value="";
      outputDiv.style.display="none";
      document.getElementById(previewId).src="";
      document.getElementById(previewId).style.display="none";
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
      document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
      document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
      document.getElementById(resetId).style.display="none";
    };
    [1,2].forEach(num=>{
      document.getElementById(`reset${num}`).addEventListener("click",()=>{
        handleResetIndividual(`reset${num}`,`file${num}`,`preview${num}`);
      });
    });

    function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
    function isSafari() {
      const ua = navigator.userAgent;
      return /^((?!chrome|android).)*safari/i.test(ua);
    }
    copyBtn.onclick=async()=>{
      const canvas=document.getElementById("canvas");
      canvas.toBlob(async blob=>{
        try{ await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]); showToast(t("alertCopySuccess"), "success"); }
        catch(e){ showToast(t("alertCopyError")+e,"error");}
      },"image/png");
    };

    function getCropBox(img) {
      if(selectedPattern==="ritual"){
        return { x: img.width*0.05, y: img.height*0.1125, w: img.width*0.325, h: img.height*0.8125 };
      } else if (selectedPattern==="status") {
        return { x: img.width*0.35, y: img.height*0.27, w: img.width*0.40, h: img.height*0.58 };
      } else if (selectedPattern==="preset") {
        return { x: img.width*0.41, y: img.height*0.14, w: img.width*0.4, h: img.height*0.725 };
      }
      return { x: 0, y: 0, w: 0, h: 0 };
    }

    function handleClickDownloadLink(e) {
      if (!e.isTrusted) {
        return;
      }

      e.preventDefault();

      // ファイル名設定
      const userCustomName = downloadNameInput.value.trim();
      if (userCustomName) {
        downloadLink.download = userCustomName.endsWith(".jpg") ? userCustomName : `${userCustomName}.jpg`;
      } else {
        // デフォルトファイル名生成
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        const hh = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        const ss = String(now.getSeconds()).padStart(2,'0');
        const defaultName = `enr_merged_relics_${yyyy}${mm}${dd}_${hh}${min}${ss}.jpg`;
        downloadLink.download = defaultName;
      }

      // ダウンロード実行
      e.target.click();
    }
    downloadLink.addEventListener("click", handleClickDownloadLink);

    async function generateMergedImage() {
      const file1 = file1Input.files[0], file2 = file2Input.files[0];
      if(!file1&&!file2){ return; }
      else if(!file1||!file2){ showToast(t("alertSelectTwoImages"),"info"); return; }

      // 一部要素を初期化
      document.querySelectorAll("#output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);

      const img1 = await loadImage(file1);
      const img2 = await loadImage(file2);
      const crop1 = getCropBox(img1);
      const crop2 = getCropBox(img2);

      // Canvas サイズ（文字＋QRスペース分 高さを少し追加）
      const canvas = document.getElementById("canvas");
      canvas.width = crop1.w + crop2.w;
      canvas.height = crop1.h;
      const baseHeight = crop1.h;
      const multiplier = Math.min(crop1.w, baseHeight) / Math.max(crop1.w, baseHeight);
      const fontSize = Math.max(12, baseHeight * multiplier * 0.04);  // 最小12px
      const qrSize = Math.max(40, baseHeight * multiplier * 0.12);   // 最小40px
      if (addTextQrCheckbox.checked) {
        canvas.height += Math.max(qrSize, fontSize) + 10;
      }

      const ctx = canvas.getContext("2d");

      // 元画像描画
      ctx.drawImage(img1, crop1.x, crop1.y, crop1.w, crop1.h, 0, 0, crop1.w, crop1.h);
      ctx.drawImage(img2, crop2.x, crop2.y, crop2.w, crop2.h, crop1.w, 0, crop2.w, crop2.h);

      if (addTextQrCheckbox.checked) {
        // 文字描画
        const text1 = t("generatedBy");
        const text2 = `https://17number.github.io/enr-relics-merger/`;
        ctx.font = `${fontSize}px sans-serif`;
        ctx.fillStyle = "white";
        ctx.strokeStyle = "lightskyblue";
        ctx.textAlign = "left";
        ctx.strokeText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
        ctx.fillText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
        ctx.strokeText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));
        ctx.fillText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));

        // QRコード生成
        const qr = qrcode(0, 'L');
        qr.addData(text2);
        qr.make();
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = qrSize;
        qrCanvas.height = qrSize;
        const qrCtx = qrCanvas.getContext("2d");
        const tileW = qrSize / qr.getModuleCount();
        const tileH = qrSize / qr.getModuleCount();
        for(let r=0; r<qr.getModuleCount(); r++){
          for(let c=0; c<qr.getModuleCount(); c++){
            qrCtx.fillStyle = qr.isDark(r, c) ? "#293179" : "#ffffff";
            qrCtx.fillRect(c*tileW, r*tileH, tileW, tileH);
          }
        }
        // Canvas に QR を貼り付け（右下）
        ctx.drawImage(qrCanvas, canvas.width - qrSize - 10, canvas.height - qrSize - 5);
      }

      // 出力画像
      const dataUrl = canvas.toDataURL("image/jpeg");
      outputImg.src = dataUrl;
      outputImg.style.display = "block";
      outputDiv.style.display = "block";

      showToast(t("alertGenerateSuccess"), "success");

      // ダウンロード設定
      downloadLink.href = dataUrl;
      downloadLink.style.display = "inline-block";

      // iOS 対応コピー
      document.querySelectorAll(".ios-copy-info").forEach(el => el.remove());
      if (!isiOS() && !isSafari()){
        copyBtn.style.display="inline-block";
      } else {
        // Safari や iOS で Clipboard API が使えない場合はコピー非表示
        copyBtn.style.display="none";
        const infoText = document.createElement("p");
        infoText.id = "ios-copy-info";
        if (isiOS()) {
          infoText.textContent = t("longTap");
        } else {
          infoText.textContent = t("longTapOrRightClick");
        }
        infoText.style.color="#555";
        infoText.style.margin="0";
        infoText.classList.add("ios-copy-info");
        copyBtn.parentElement.insertAdjacentElement("beforeend", infoText);
      }
    }

    // ドラッグ＆ドロップ
    const dropZone=document.getElementById("drop-zone");
    dropZone.addEventListener("dragover",e=>{
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave",()=>{
      dropZone.classList.remove("dragover");
    });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");

      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
      if(files.length === 0) return;

      // 1枚ドロップ
      if(files.length === 1){
        if(!file1Input.files[0]){
          const dt1 = new DataTransfer();
          dt1.items.add(files[0]);
          file1Input.files = dt1.files;
          setPreview(files[0], preview1, reset1);
        } else if(!file2Input.files[0]){
          const dt2 = new DataTransfer();
          dt2.items.add(files[0]);
          file2Input.files = dt2.files;
          setPreview(files[0], preview2, reset2);
        } else {
          showToast(t("alertBothFramesFilled"), "error");
        }
      }
      // 2枚以上ドロップ → 総入れ替え
      else {
        const dt1 = new DataTransfer();
        const dt2 = new DataTransfer();
        dt1.items.add(files[0]);
        dt2.items.add(files[1]);
        file1Input.files = dt1.files;
        file2Input.files = dt2.files;
        setPreview(files[0], preview1, reset1);
        setPreview(files[1], preview2, reset2);
      }

      generateMergedImage();
    });

    // 個別ドラッグ＆ドロップ
    function enableDropOnBlock(blockEl, previewEl, resetEl, fileInput) {
      // ドラッグ中の見た目を変える
      blockEl.addEventListener("dragover", e => {
        e.preventDefault();
        blockEl.style.border = "2px dashed #3399ff";
        blockEl.style.background = "#3399ff33";
      });

      blockEl.addEventListener("dragleave", () => {
        blockEl.style.border = "";
        blockEl.style.background = "";
      });

      // ドロップされたときの処理
      blockEl.addEventListener("drop", e => {
        e.preventDefault();
        blockEl.style.border = "";
        blockEl.style.background = "";
        if (!e.dataTransfer.files.length) return;

        const file = e.dataTransfer.files[0];
        if (!file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = ev => {
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          setPreview(fileInput.files[0], previewEl, resetEl);
          generateMergedImage();
        };
        reader.readAsDataURL(file);
      });
    }

    // .file-block をドロップ対象にする
    enableDropOnBlock(fileBlock1, preview1, reset1, file1Input);
    enableDropOnBlock(fileBlock2, preview2, reset2, file2Input);

    // オーバーレイ
    function enableOverlay(selector) {
      document.querySelectorAll(selector).forEach(img => {
        img.addEventListener("click", () => {
          const overlay = document.getElementById("overlay");
          const overlayImg = document.getElementById("overlay-img");
          overlayImg.src = img.src;
          overlay.classList.add("active");
        });
      });
    }
    enableOverlay("#preview1, #preview2, #output-img, .sample-area img");
    const overlay=document.getElementById("overlay");
    overlay.addEventListener("click",()=>overlay.classList.remove("active"));

    // バージョン情報取得・表示
    fetch("./version.json")
      .then(res => res.json())
      .then(v => {
        const hash = v.hash;
        const date = new Date(v.date).toLocaleString();
        document.getElementById("version").textContent =
          `Commit: ${hash} (${date})`;
      })
      .catch(() => {});
  </script>
</body>
</html>
