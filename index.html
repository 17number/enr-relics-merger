<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">ELDEN RING NIGHTREIGN 遺物画像結合ツール</title>
  <meta name="description" content="ELDEN RING NIGHTREIGN(ナイトレイン)の 1〜3枠、4〜6枠の遺物効果画像を1枚にまとめるツール / Tool for merging relic effect images from ELDEN RING NIGHTREIGN (1-3 slots, 4-6 slots) into a single image">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="ELDEN RING NIGHTREIGN,ナイトレイン,遺物,画像結合,Relic,Relics,Image Merger">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://17number.github.io/enr-relics-merger/">
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 20px; background: #f8f9fa; color:#333; font-size: 16px; }
    h1 { font-size: 1.4rem; }
    .input-area { display: flex; gap: 20px; flex-wrap: wrap; }
    .pattern-block input[type="radio"], .pattern-block label { cursor: pointer; }
    .file-block { flex: 1; min-width: 200px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .file-block h3 { margin: 0 0 8px; font-size: 1rem; }
    .preview { display:block; max-width: min(400px, 80vw); max-height: 400px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    .drop-zone { border: 2px dashed #999; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center; color: #666; background:#fff; }
    .drop-zone.dragover { border-color: #333; background: #f0f0f0; }
    button, a { margin: 10px 5px 20px 0; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px; cursor: pointer; }
    #swap { background:#3399ff; color:#fff; }
    #generate { background:#007bff; color:#fff; }
    #generate:disabled { background:#ccc; cursor:not-allowed; }
    #reset { background:#dc3545; color:#fff; }
    #add-text-qr, label[for="add-text-qr"] { cursor: pointer; }
    #download { background:#28a745; color:#fff; display:none; text-decoration:none; }
    #copy { background:#17a2b8; color:#fff; display:none; }
    #canvas { display:none; }
    #output { display:none; }
    #output-img { margin-top:10px; max-width: 80vw; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    #ocr-output { display: none; margin-top: 10px; font-family: monospace; color: #333; }
    .sample-area img { max-width: min(400px, 80vw); margin: 5px; border: 1px solid #ccc; border-radius:6px; cursor:pointer; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .overlay img { max-width: 90vw; max-height: 90vh; border-radius:8px; box-shadow:0 0 10px #000; }
    .overlay.active { visibility: visible; opacity: 1; }

    /* トースト通知 */
    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      /* transform: translateX(-50%); */
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 10000;
    }

    @media (max-width: 768px), (hover: none) and (pointer: coarse) { body { font-size: 18px; } .drop-zone { display:none; } }
  </style>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ENR Relics Merger",
      "url": "https://17number.github.io/enr-relics-merger/",
      "applicationCategory": "Game",
      "operatingSystem": "Web",
      "description": "ELDEN RING NIGHTREIGN の遺物画像を結合する簡単なウェブツール。",
      "image": "https://17number.github.io/enr-relics-merger/images/sample_a3_1-6.jpg"
    }
  </script>
  <meta name="google-site-verification" content="yr6qjqaE9dOm6wsDFdWNKrCc6EJAmBnvMaDcQ0ILT8w" />
</head>
<body>
  <h1 data-i18n="title">ELDEN RING NIGHTREIGN 遺物画像結合ツール</h1>
  <div style="margin-bottom: 1rem;">
    <span>Language:</span>
    <input type="radio" id="lang-ja" name="langSelect" value="ja" checked>
    <label for="lang-ja">🇯🇵 日本語</label>
    <input type="radio" id="lang-en" name="langSelect" value="en">
    <label for="lang-en">🇺🇸 English</label>
  </div>
  <p style="margin: 0" data-i18n="desc" data-i18n-html>1〜3枠、4〜6枠の遺物効果画像を1枚にまとめます。結合したい 遺物儀式の画像/ステータス画面の画像/プリセット画面の画像 を2枚選択してください。( <a href="#sample" style="padding: 0;">サンプル</a>)</p>
  <!-- 注意事項 -->
  <details style="margin:10px 0;">
    <summary style="cursor: pointer; color:#007bff;" data-i18n="noteSummary">注意事項 (クリックで展開)</summary>
    <ul style="color:#555; font-size: 0.9rem; margin: 0.25rem 0 1rem; padding-inline-start: 30px;">
      <li data-i18n="note1">画像はそれぞれ1〜3枠、4〜6枠の遺物効果が写っている必要があります。</li>
      <li data-i18n="note2">座標指定で切り抜いているため画像サイズなどの要因で正常に結合できない場合があります。</li>
      <li data-i18n="note3">選択できる画像は2枚までです。ドラッグ＆ドロップで2枚以上選択した場合は先頭の2枚が使用されます。</li>
      <li data-i18n="note4">選択した画像はブラウザ上で処理され、サーバーには送信されません。</li>
      <li data-i18n="note5" data-i18n-html>文字認識(OCR)機能はβ版です。<a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>を使用しています。認識精度は保証されません。</li>
      <li data-i18n="note6">このツールは非公式のものであり、ELDEN RING NIGHTREIGNとは関係ありません。</li>
      <li data-i18n="note7" data-i18n-html>なにかあれば <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>からご連絡ください。可能な範囲で対応します。すでに<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">類似の Issue が無いかを事前確認</a>したうえでご連絡頂けると助かります</li>
    </ul>
  </details>

  <h2 data-i18n="mergeSettings">結合画像設定</h2>

  <!-- 画面タイプ選択 -->
  <div class="pattern-block" style="margin-bottom: 0.5rem">
    <fieldset>
      <legend data-i18n="patternSelect">画面タイプを選択</legend>
      <input type="radio" name="pattern" id="pattern-ritual" value="ritual" checked><label for="pattern-ritual" data-i18n="patternRitual">遺物儀式画面 (デフォルト)</label><br>
      <input type="radio" name="pattern" id="pattern-status" value="status"><label for="pattern-status" data-i18n="patternStatus">ステータス画面</label><br>
      <input type="radio" name="pattern" id="pattern-preset" value="preset"><label for="pattern-preset" data-i18n="patternPreset">プリセット画面</label>
    </fieldset>
  </div>

  <div class="input-area">
    <div class="file-block">
      <h3 data-i18n="relic1_3">遺物1〜3</h3>
      <input type="file" id="file1" accept="image/*">
      <img id="preview1" class="preview" alt="プレビュー1" style="display:none;">
    </div>
    <div class="file-block">
      <h3 data-i18n="relic4_6">遺物4〜6</h3>
      <input type="file" id="file2" accept="image/*">
      <img id="preview2" class="preview" alt="プレビュー2" style="display:none;">
    </div>
  </div>

  <div class="drop-zone" id="drop-zone" data-i18n="dropHere">ここに画像をドラッグ＆ドロップできます (2枚)</div>

  <button id="swap" data-i18n="swap">画像入れ替え</button>
  <button id="generate" disabled data-i18n="generate">生成</button>
  <button id="reset" data-i18n="reset">リセット</button>
  <div style="display: inline-block;">
    <input type="checkbox" id="add-text-qr" checked>
    <label for="add-text-qr" data-i18n="qrEmbed">Generated By/QRコード 埋め込み</label>
  </div>

  <div id="output">
    <h2 style="margin-bottom: 0" data-i18n="result">出力結果</h2>
    <div>
      <a id="download" data-i18n="download">ダウンロード</a>
      <button id="copy" data-i18n="copy">コピー</button>
    </div>
    <canvas id="canvas"></canvas>
    <img id="output-img" alt="結合結果">
  </div>

  <div id="ocr-output">
    <h3 data-i18n="ocrTitle">文字抽出結果(β版)</h3>
    <h4 data-i18n="relic1_3">遺物1〜3</h4>
    <div id="ocr-output-inner1" style="white-space: pre-wrap;"></div>
    <h4 data-i18n="relic4_6">遺物4〜6</h4>
    <div id="ocr-output-inner2" style="white-space: pre-wrap;"></div>
  </div>

  <h2 id="sample" data-i18n="sample">サンプル</h2>
  <div class="sample-area">
    <h3 data-i18n="pattern1">パターン1(遺物儀式画面)</h3>
    <div class="sample-pattern1">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_a1_1-3.jpg" alt="サンプル_a1" loading="lazy">
      <img src="images/sample_a2_4-6.jpg" alt="サンプル_a2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_a3_1-6.jpg" alt="サンプル_a3_結合結果" loading="lazy">
    </div>
    <h3 data-i18n="pattern2">パターン2(ステータス画面)</h3>
    <div class="sample-pattern2">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_b1_1-3.jpg" alt="サンプル_b1" loading="lazy">
      <img src="images/sample_b2_4-6.jpg" alt="サンプル_b2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_b3_1-6.jpg" alt="サンプル_b3_結合結果" loading="lazy">
    </div>
    <h3 data-i18n="pattern3">パターン3(プリセット画面)</h3>
    <div class="sample-pattern3">
      <p data-i18n="inputExample">入力例:</p>
      <img src="images/sample_c1_1-3.jpg" alt="サンプル_c1" loading="lazy">
      <img src="images/sample_c2_4-6.jpg" alt="サンプル_c2" loading="lazy">
      <p data-i18n="outputExample">出力例:</p>
      <img src="images/sample_c3_1-6.jpg" alt="サンプル_c3_結合結果" loading="lazy">
    </div>
  </div>

  <!-- バージョン情報表示エリア -->
  <div id="version" style="font-size: 0.9em; color: #666; margin-top: 1rem; text-align: center;"></div>

  <div class="overlay" id="overlay">
    <img id="overlay-img" src="" alt="拡大表示">
  </div>

  <!-- トースト通知 -->
  <div id="toast"></div>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BN1ZV55K0M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BN1ZV55K0M');
  </script>

  <!-- QRコード -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@2.0.4/dist/qrcode.min.js"></script>
  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <script>
    /********************
     * 多言語辞書
     ********************/
    const i18n = {
      ja: {
        alertBothFramesFilled: "既に両方の枠が埋まっています。2枚まとめてドラッグ＆ドロップするか、リセットしてやり直してください。",
        alertCopyError: "コピー失敗: ",
        alertCopySuccess: "画像をクリップボードにコピーしました",
        alertGenerateSuccess: "結合画像を生成しました",
        alertSelectTwoImages: "画像を2枚選択してください",
        copy: "コピー",
        desc: `1〜3枠、4〜6枠の遺物効果画像を1枚にまとめます。結合したい 遺物儀式の画像/ステータス画面の画像/プリセット画面の画像 を2枚選択してください。( <a href="#sample" style="padding: 0;">サンプル</a>)`,
        download: "ダウンロード",
        dropHere: "ここに画像をドラッグ＆ドロップできます (2枚)",
        errorOCRFailed: "OCRに失敗: ",
        generate: "生成",
        generatedBy: "Generated by ELDEN RING NIGHTREIGN 遺物画像結合ツール",
        inputExample: "入力例:",
        longTap: "画像の コピー/保存/etc をしたい場合は以下画像をロングタップしてください。",
        mergeSettings: "結合画像設定",
        note1: "画像はそれぞれ1〜3枠、4〜6枠の遺物効果が写っている必要があります。",
        note2: "座標指定で切り抜いているため画像サイズなどの要因で正常に結合できない場合があります。",
        note3: "選択できる画像は2枚までです。ドラッグ＆ドロップで2枚以上選択した場合は先頭の2枚が使用されます。",
        note4: "選択した画像はブラウザ上で処理され、サーバーには送信されません。",
        note5: `文字認識(OCR)機能はβ版です。<a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>を使用しています。認識精度は保証されません。`,
        note6: "このツールは非公式のものであり、ELDEN RING NIGHTREIGNとは関係ありません。",
        note7: `なにかあれば <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>からご連絡ください。可能な範囲で対応します。すでに<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">類似の Issue が無いかを事前確認</a>したうえでご連絡頂けると助かります`,
        noteSummary: "注意事項 (クリックで展開)",
        ocrProcessing: "OCR 読み取り中…",
        ocrTitle: "文字抽出結果(β版)",
        outputExample: "出力例:",
        pattern1: "パターン1(遺物儀式画面)",
        pattern2: "パターン2(ステータス画面)",
        pattern3: "パターン3(プリセット画面)",
        patternPreset: "プリセット画面",
        patternRitual: "遺物儀式画面 (デフォルト)",
        patternSelect: "画面タイプを選択",
        patternStatus: "ステータス画面",
        progress: "処理中...",
        qrEmbed: "Generated By/QRコード 埋め込み",
        relic1_3: "遺物1〜3",
        relic4_6: "遺物4〜6",
        reset: "リセット",
        result: "出力結果",
        sample: "サンプル",
        swap: "画像入れ替え",
        title: "ELDEN RING NIGHTREIGN 遺物画像結合ツール",
      },
      en: {
        alertBothFramesFilled: "Both frames are already filled. Please drag and drop two images at once or reset and try again.",
        alertCopyError: "Copy failed: ",
        alertCopySuccess: "Image copied to clipboard",
        alertGenerateSuccess: "Combined image generated",
        alertSelectTwoImages: "Please select two images",
        copy: "Copy",
        desc: `Combine relic effect images of slots 1–3 and 4–6 into one image. Please select two images from the relic rites screen or the status screen or the preset screen that you want to combine. ( <a href="#sample" style="padding: 0;">Examples</a>)`,
        download: "Download",
        dropHere: "Drag & Drop images here (2 images)",
        errorOCRFailed: "OCR failed: ",
        generate: "Generate",
        generatedBy: "Generated by ELDEN RING NIGHTREIGN Relic Image Merger",
        inputExample: "Input Example:",
        longTap: "Long-press the image to copy/save/etc.",
        mergeSettings: "Settings",
        note1: "Each image must show the relic effects for slots 1–3 and 4–6.",
        note2: "Due to the cropping method used, images may not combine correctly depending on their size and other factors.",
        note3: "You can select up to 2 images. If you select more than 2 images via drag & drop, only the first 2 will be used.",
        note4: "The selected images are processed in the browser and are not sent to the server.",
        note5: `The OCR feature is in beta. It uses <a href="https://tesseract.projectnaptha.com/" target="_blank" style="padding: 0;">Tesseract.js</a>. Recognition accuracy is not guaranteed.`,
        note6: "This tool is unofficial and is not affiliated with ELDEN RING NIGHTREIGN.",
        note7: `If you have any questions, please contact us via <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0;">Issues</a>. We will respond as much as possible. It would be helpful if you could check for <a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0;">similar issues</a> beforehand.`,
        noteSummary: "Notes (Click to Expand)",
        ocrProcessing: "OCR Processing...",
        ocrTitle: "OCR Results (Beta)",
        outputExample: "Output Example:",
        pattern1: "Pattern 1 (Relic Rites Screen)",
        pattern2: "Pattern 2 (Status Screen)",
        pattern3: "Pattern 3 (Preset Screen)",
        patternPreset: "Preset Screen",
        patternRitual: "Relic Rites Screen (Default)",
        patternSelect: "Select Screen Type",
        patternStatus: "Status Screen",
        progress: "Processing...",
        qrEmbed: "With Generated By/QR Code",
        relic1_3: "Relics 1–3",
        relic4_6: "Relics 4–6",
        reset: "Reset",
        result: "Result",
        sample: "Examples",
        swap: "Swap Images",
        title: "ELDEN RING NIGHTREIGN Relic Image Merger",
      }
    };

    function applyLang(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[lang] && i18n[lang][key]) {
          if (el.dataset.i18nHtml !== undefined) {
            el.innerHTML = i18n[lang][key];
          } else {
            el.textContent = i18n[lang][key];
          }
        }
      });
      localStorage.setItem("lang", lang);
    }

    function t(key) {
      const lang = localStorage.getItem("lang") || "ja";
      return (i18n[lang] && i18n[lang][key]) || key;
    }

    /********************
     * 言語初期化
     ********************/
    const savedLang = localStorage.getItem("lang") || "ja";
    document.querySelector("input[name='langSelect'][value='" + savedLang + "']").checked = true;
    applyLang(savedLang);

    document.querySelectorAll("input[name='langSelect']").forEach(radio => {
      radio.addEventListener("change", e => {
        applyLang(e.target.value);
      });
    });

    /********************
     * トースト通知
     ********************/
    function showToast(message, type="info", duration=3000){
      const toast = document.getElementById("toast");
      toast.textContent = message;
      if(type==="error") toast.style.background="rgba(220,53,69,0.85)";
      else if(type==="success") toast.style.background="rgba(40,167,69,0.85)";
      else toast.style.background="rgba(0,0,0,0.85)";
      toast.style.opacity=1;
      toast.style.pointerEvents="auto";
      clearTimeout(toast._timeout);
      toast._timeout = setTimeout(()=>{
        toast.style.opacity=0;
        toast.style.pointerEvents="none";
      }, duration);
    }

    /********************
     * メイン処理
     ********************/
    const file1Input = document.getElementById("file1");
    const file2Input = document.getElementById("file2");
    const swapBtn = document.getElementById("swap");
    const generateBtn = document.getElementById("generate");
    const resetBtn = document.getElementById("reset");
    const addTextQrCheckbox = document.getElementById("add-text-qr");
    const copyBtn = document.getElementById("copy");
    const downloadLink = document.getElementById("download");
    const ocrOutputDiv = document.getElementById("ocr-output");
    const ocrInner1 = document.getElementById("ocr-output-inner1");
    const ocrInner2 = document.getElementById("ocr-output-inner2");
    const outputDiv = document.getElementById("output");
    const outputImg = document.getElementById("output-img");

    let replaceRules = {};

    // 外部置換ルール読み込み
    async function loadReplaceRules() {
      try {
        const res = await fetch('./replace_rules.json');
        replaceRules = await res.json();
      } catch(e){ console.warn("置換ルール読み込み失敗",e); replaceRules={}; }
    }
    loadReplaceRules();

    // 画面タイプ選択
    let selectedPattern = "ritual";
    document.querySelectorAll('input[name="pattern"]').forEach(radio=>{
      radio.addEventListener("change",e=>selectedPattern=e.target.value);
    });

    async function loadImage(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>resolve(img);
          img.src=e.target.result;
        };
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function setPreview(file, previewId){
      const reader=new FileReader();
      reader.onload=e=>{
        const img=document.getElementById(previewId);
        img.src=e.target.result; img.style.display="block";
      };
      reader.readAsDataURL(file);
    }

    function updateGenerateButton(){
      generateBtn.disabled = !(file1Input.files[0] && file2Input.files[0]);
    }

    file1Input.addEventListener("change",()=>{ setPreview(file1Input.files[0],"preview1"); updateGenerateButton(); });
    file2Input.addEventListener("change",()=>{ setPreview(file2Input.files[0],"preview2"); updateGenerateButton(); });
    updateGenerateButton();

    swapBtn.addEventListener("click", () => {
      // ファイルオブジェクトを入れ替え
      const tempFiles = file1Input.files;
      file1Input.files = file2Input.files;
      file2Input.files = tempFiles;

      // プレビューも入れ替え
      const tempSrc = document.getElementById("preview1").src;
      document.getElementById("preview1").src = document.getElementById("preview2").src;
      document.getElementById("preview2").src = tempSrc;

      // プレビュー表示制御
      document.getElementById("preview1").style.display = file1Input.files[0] ? "block" : "none";
      document.getElementById("preview2").style.display = file2Input.files[0] ? "block" : "none";

      // 生成ボタン状態更新
      updateGenerateButton();
    });

    function handleReset(){
      file1Input.value=""; file2Input.value="";
      outputDiv.style.display="none";
      document.querySelectorAll("#preview1, #preview2, #output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
      ocrOutputDiv.style.display="none";
      document.querySelectorAll("#ocr-output-inner1, #ocr-output-inner2").forEach(div=>{ div.textContent=""; });
      document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
      document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
      updateGenerateButton();
    };
    resetBtn.addEventListener("click",handleReset);

    async function preprocessImage(file){
      const img = await loadImage(file);
      const canvas=document.createElement("canvas");
      canvas.width=img.width; canvas.height=img.height;
      const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      const data=imageData.data;
      for(let i=0;i<data.length;i+=4){
        const avg=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
        data[i]=data[i+1]=data[i+2]=avg;
      }
      ctx.putImageData(imageData,0,0);
      const scaled=document.createElement("canvas"); scaled.width=canvas.width*2; scaled.height=canvas.height*2;
      scaled.getContext("2d").drawImage(canvas,0,0,scaled.width,scaled.height);
      return scaled;
    }

    function getOcrCropBox(img) {
      if (selectedPattern==="ritual"){
        return { x: img.width*0.075, y: img.height*0.385, w: img.width*(0.325-0.075), h: img.height*(0.925-0.385) };
      } else if (selectedPattern==="status"){
        return { x: img.width*0.425, y: img.height*0.27, w: img.width*0.325, h: img.height*0.58 };
      } else if (selectedPattern==="preset"){
        return { x: img.width*0.5, y: img.height*0.15, w: img.width*0.4, h: img.height*0.305 };
      }
      return { x: 0, y: 0, w: 0, h: 0 };
    }

    async function runOCR(file, outputDiv){
      const processed = await preprocessImage(file);
      const { x: cropX, y: cropY, w: cropW, h: cropH } = getOcrCropBox(processed);
      const cropCanvas=document.createElement("canvas"); cropCanvas.width=cropW; cropCanvas.height=cropH;
      cropCanvas.getContext("2d").drawImage(processed,cropX,cropY,cropW,cropH,0,0,cropW,cropH);

      const { data:{ text } } = await Tesseract.recognize(cropCanvas,'jpn',{
        logger:m=>{ if(m.status==='recognizing text') outputDiv.textContent=`${t("ocrProcessing")} ${Math.floor(m.progress*100)}%`; }
      });

      const lines=text.split('\n').map(l=>l.replace(/\s+/g,''));
      const replaced=lines.map(l=>{
        let s=l;
        for(const key in replaceRules){ s=s.split(key).join(replaceRules[key]); }
        return s;
      });
      return replaced.join('\n');
    }

    function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
    copyBtn.onclick=async()=>{
      const canvas=document.getElementById("canvas");
      canvas.toBlob(async blob=>{
        try{ await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]); showToast(t("alertCopySuccess"), "success"); }
        catch(e){ showToast(t("alertCopyError")+e,"error");}
      },"image/png");
    };

    function getCropBox(img) {
      if(selectedPattern==="ritual"){
        return { x: img.width*0.05, y: img.height*0.1125, w: img.width*0.325, h: img.height*0.8125 };
      } else if (selectedPattern==="status") {
        return { x: img.width*0.35, y: img.height*0.27, w: img.width*0.40, h: img.height*0.58 };
      } else if (selectedPattern==="preset") {
        return { x: img.width*0.41, y: img.height*0.14, w: img.width*0.4, h: img.height*0.725 };
      }
      return { x: 0, y: 0, w: 0, h: 0 };
    }

    generateBtn.addEventListener("click", async () => {
      const file1 = file1Input.files[0], file2 = file2Input.files[0];
      if(!file1||!file2){ showToast(t("alertSelectTwoImages"), "error"); return; }

      // 一部要素を初期化
      document.querySelectorAll("#output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
      document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
      ocrOutputDiv.style.display="none";
      document.querySelectorAll("#ocr-output-inner1, #ocr-output-inner2").forEach(div=>{ div.textContent=""; });

      const img1 = await loadImage(file1);
      const img2 = await loadImage(file2);
      const crop1 = getCropBox(img1);
      const crop2 = getCropBox(img2);

      // Canvas サイズ（文字＋QRスペース分 高さを少し追加）
      const canvas = document.getElementById("canvas");
      canvas.width = crop1.w + crop2.w;
      const baseHeight = crop1.h;
      const multiplier = Math.min(crop1.w, baseHeight) / Math.max(crop1.w, baseHeight);
      const fontSize = Math.max(12, baseHeight * multiplier * 0.04);  // 最小12px
      const qrSize = Math.max(40, baseHeight * multiplier * 0.12);   // 最小40px
      if (!addTextQrCheckbox.checked) {
        canvas.height = Math.max(crop1.h, crop2.h);
      } else {
        canvas.height = Math.max(crop1.h, crop2.h) + Math.max(qrSize, fontSize) + 10; // 10px 余白
      }

      const ctx = canvas.getContext("2d");

      // 元画像描画
      ctx.drawImage(img1, crop1.x, crop1.y, crop1.w, crop1.h, 0, 0, crop1.w, crop1.h);
      ctx.drawImage(img2, crop2.x, crop2.y, crop2.w, crop2.h, crop1.w, 0, crop2.w, crop2.h);

      if (addTextQrCheckbox.checked) {
        // 文字描画
        const text1 = t("generatedBy");
        const text2 = `https://17number.github.io/enr-relics-merger/`;
        ctx.font = `${fontSize}px sans-serif`;
        ctx.fillStyle = "white";
        ctx.strokeStyle = "lightskyblue";
        ctx.textAlign = "left";
        ctx.strokeText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
        ctx.fillText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
        ctx.strokeText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));
        ctx.fillText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));

        // QRコード生成
        const qr = qrcode(0, 'L');
        qr.addData(text2);
        qr.make();
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = qrSize;
        qrCanvas.height = qrSize;
        const qrCtx = qrCanvas.getContext("2d");
        const tileW = qrSize / qr.getModuleCount();
        const tileH = qrSize / qr.getModuleCount();
        for(let r=0; r<qr.getModuleCount(); r++){
          for(let c=0; c<qr.getModuleCount(); c++){
            qrCtx.fillStyle = qr.isDark(r, c) ? "#293179" : "#ffffff";
            qrCtx.fillRect(c*tileW, r*tileH, tileW, tileH);
          }
        }
        // Canvas に QR を貼り付け（右下）
        ctx.drawImage(qrCanvas, canvas.width - qrSize - 10, canvas.height - qrSize - 5);
      }

      // 出力画像
      const dataUrl = canvas.toDataURL("image/jpeg");
      outputImg.src = dataUrl;
      outputImg.style.display = "block";
      outputDiv.style.display = "block";

      showToast(t("alertGenerateSuccess"), "success");

      // ダウンロード設定
      const now = new Date();
      downloadLink.href = dataUrl;
      downloadLink.download = `enr_merged_relics_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}.jpg`;
      downloadLink.style.display = "inline-block";

      // iOS 対応コピー
      document.querySelectorAll(".ios-copy-info").forEach(el => el.remove());
      if(isiOS()){
        const infoText = document.createElement("p");
        infoText.textContent = t("longTap");
        infoText.style.color="#555";
        infoText.style.margin="0";
        infoText.classList.add("ios-copy-info");
        copyBtn.parentNode.insertBefore(infoText, copyBtn.nextSibling);
      } else {
        copyBtn.style.display="inline-block";
      }

      // OCR処理
      ocrOutputDiv.style.display="block";
      try {
        ocrInner1.textContent = await runOCR(file1, ocrInner1);
        ocrInner2.textContent = await runOCR(file2, ocrInner2);
      } catch(e) { ocrOutputDiv.textContent = t("errorOCRFailed") + e; }
    });

    const dropZone=document.getElementById("drop-zone");
    dropZone.addEventListener("dragover",e=>{ e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave",()=>{ dropZone.classList.remove("dragover"); });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");

      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
      if(files.length === 0) return;

      // 1枚ドロップ
      if(files.length === 1){
        if(!file1Input.files[0]){
          const dt1 = new DataTransfer();
          dt1.items.add(files[0]);
          file1Input.files = dt1.files;
          setPreview(files[0], "preview1");
        } else if(!file2Input.files[0]){
          const dt2 = new DataTransfer();
          dt2.items.add(files[0]);
          file2Input.files = dt2.files;
          setPreview(files[0], "preview2");
        } else {
          showToast(t("alertBothFramesFilled"), "error");
        }
      }
      // 2枚以上ドロップ → 総入れ替え
      else {
        const dt1 = new DataTransfer();
        const dt2 = new DataTransfer();
        dt1.items.add(files[0]);
        dt2.items.add(files[1]);
        file1Input.files = dt1.files;
        file2Input.files = dt2.files;
        setPreview(files[0], "preview1");
        setPreview(files[1], "preview2");
      }

      updateGenerateButton();
    });

    // オーバーレイ
    function enableOverlay(selector) {
      document.querySelectorAll(selector).forEach(img => {
        img.addEventListener("click", () => {
          const overlay = document.getElementById("overlay");
          const overlayImg = document.getElementById("overlay-img");
          overlayImg.src = img.src;
          overlay.classList.add("active");
        });
      });
    }
    enableOverlay("#preview1, #preview2, #output-img, .sample-area img");
    const overlay=document.getElementById("overlay");
    overlay.addEventListener("click",()=>overlay.classList.remove("active"));

    // バージョン情報取得・表示
    fetch("./version.json")
      .then(res => res.json())
      .then(v => {
        const hash = v.hash;
        const date = new Date(v.date).toLocaleString();
        document.getElementById("version").textContent =
          `Commit: ${hash} (${date})`;
      })
      .catch(() => {});
  </script>
</body>
</html>
