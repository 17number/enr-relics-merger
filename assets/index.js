// QR コード
function insertScriptForQR(){
  const script=document.createElement("script");
  script.src="https://cdn.jsdelivr.net/npm/qrcode-generator@2.0.4/dist/qrcode.min.js";
  document.head.appendChild(script);
}
insertScriptForQR();

// Google Analytics
let gtag = () => {};
function insertScriptForGA() {
  if (isOptOutGA()) return;

  window.dataLayer = window.dataLayer || [];
  gtag = function(){dataLayer.push(arguments);};

  // スクリプト読み込み完了後に初期化
  const script = document.createElement("script");
  script.src = "https://www.googletagmanager.com/gtag/js?id=G-BN1ZV55K0M";
  script.async = true;
  script.onload = () => {
    gtag('js', new Date());
    gtag('config', 'G-BN1ZV55K0M', { anonymize_ip: true });
  };
  document.head.appendChild(script);
}
insertScriptForGA();

function isOptOutGA(){
  const url = new URL(location.href);
  const isNotProduction = (
    url.hostname !== "17number.github.io" ||
    !url.pathname.startsWith("/enr-relics-merger")
  );
  return isNotProduction;
}

// GoatCounter
function insertScriptForGoatCounter() {
  const script = document.createElement("script");
  script.setAttribute("data-goatcounter", "https://r17n.goatcounter.com/count");
  script.async = true;
  script.src = "//gc.zgo.at/count.js";
  document.head.appendChild(script);
}
insertScriptForGoatCounter();


/********************
  * 多言語辞書
  ********************/
const i18n = {
  ja: {
    alertBothFramesFilled: "既に両方の枠が埋まっています。2枚まとめてドラッグ＆ドロップするか、リセットしてやり直してください。",
    alertBothFramesFilledForPaste: "既に両方の枠が埋まっています。リセットしてやり直してください。",
    alertCopyError: "コピー失敗: ",
    alertCopySuccess: "画像をクリップボードにコピーしました",
    alertGenerateSuccess: "画像を生成しました",
    alertSelectTwoImages: "2枚目の画像を選択してください",
    copy: "コピー",
    desc: `遺物(1〜3枠)、深き夜の深層遺物(4〜6枠)の遺物効果画像を1枚にまとめます。結合したい 遺物儀式の画像/ステータス画面の画像/プリセット画面の画像 を2枚選択してください。ドラッグ＆ドロップ、画像データのペースト(Win: Ctrl+v, Mac: ⌘+v)も可能です。(<a href="#sample" style="padding: 0; margin: 0;">サンプル</a>)`,
    desc2: `<a href="https://x.com/" target="_blank" style="padding: 0; margin: 0;">X</a> や <a href="https://discord.com/" target="_blank" style="padding: 0; margin: 0;">Discord</a> などで共有してもらえると嬉しいです。`,
    download: "ダウンロード",
    download_name: "ダウンロードファイル名 (省略可)",
    dropHere: "ここに画像をドラッグ＆ドロップできます (2枚)",
    dropHere6: "ここに画像をドラッグ＆ドロップできます (6枚)",
    generatedBy: "Generated by ELDEN RING NIGHTREIGN 遺物画像結合ツール",
    inputExample: "入力例:",
    longTap: "画像の コピー/保存/etc をしたい場合は以下画像をロングタップしてください。",
    longTapOrRightClick: "画像の コピー/保存/etc をしたい場合は以下画像をロングタップ(または右クリック)してください。",
    mergeSettings: "結合画像設定",
    note1: "画像はそれぞれ1〜3枠、4〜6枠の遺物効果が写っている必要があります。",
    note2: "座標指定で切り抜いているため画像サイズなどの要因で正常に結合できない場合があります。",
    note3: "選択できる画像は2枚までです。ドラッグ＆ドロップで2枚以上選択した場合は先頭の2枚が使用されます。",
    note4: "選択した画像はブラウザ上で処理され、サーバーには送信されません。",
    note6: "このツールは非公式のものであり、ELDEN RING NIGHTREIGNとは関係ありません。",
    note7: `なにかあれば <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0; margin: 0;">Issues</a>からご連絡ください。可能な範囲で対応します。すでに<a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0; margin: 0;">類似の Issue が無いかを事前確認</a>したうえでご連絡頂けると助かります`,
    noteSummary: "注意事項 (クリックで展開)",
    outputExample: "出力例:",
    pattern1: "パターン1(遺物儀式画面)",
    pattern2: "パターン2(ステータス画面)",
    pattern3: "パターン3(プリセット画面)",
    patternPreset: "プリセット画面",
    patternRitual: "遺物儀式画面",
    patternSelect: "画面タイプ",
    patternStatus: "ステータス画面",
    progress: "処理中...",
    qrEmbed: "Generated By/QRコード 埋め込み",
    relic1: "遺物1",
    relic2: "遺物2",
    relic1_3: "遺物1〜3",
    relic4_6: "遺物4〜6",
    reset: "リセット",
    result: "出力結果",
    sample: "サンプル",
    swap: "画像入れ替え",
    title: "ELDEN RING NIGHTREIGN 遺物画像結合ツール",
  },
  en: {
    alertBothFramesFilled: "Both frames are already filled. Please drag and drop two images at once or reset and try again.",
    alertBothFramesFilledForPaste: "Both frames are already filled. Please reset and try again.",
    alertCopyError: "Copy failed: ",
    alertCopySuccess: "Image copied to clipboard",
    alertGenerateSuccess: "Image generated",
    alertSelectTwoImages: "Please select the second image",
    copy: "Copy",
    desc: `Combine relic effect images of relic(slots 1–3) and deep of night depth relic(slots 4–6) into one image. Please select two images from the relic rites screen or the status screen or the preset screen that you want to combine. Drag & drop and image data can also be pasted (Win: Ctrl+v, Mac: ⌘+v). (<a href="#sample" style="padding: 0; margin: 0;">Examples</a>)`,
    desc2: `It would be great if you could share it on <a href="https://x.com/" target="_blank" style="padding: 0; margin: 0;">X</a> or <a href="https://discord.com/" target="_blank" style="padding: 0; margin: 0;">Discord</a>.`,
    download: "Download",
    download_name: "Download File Name (Optional)",
    dropHere: "Drag & Drop images here (2 images)",
    dropHere6: "Drag & Drop images here (6 images)",
    generatedBy: "Generated by ELDEN RING NIGHTREIGN Relic Image Combiner",
    inputExample: "Input Example:",
    longTap: "Long-press the image to copy/save/etc.",
    longTapOrRightClick: "Long-press or right-click the image to copy/save/etc.",
    mergeSettings: "Settings",
    note1: "Each image must show the relic effects for slots 1–3 and 4–6.",
    note2: "Due to the cropping method used, images may not combine correctly depending on their size and other factors.",
    note3: "You can select up to 2 images. If you select more than 2 images via drag & drop, only the first 2 will be used.",
    note4: "The selected images are processed in the browser and are not sent to the server.",
    note6: "This tool is unofficial and is not affiliated with ELDEN RING NIGHTREIGN.",
    note7: `If you have any questions, please contact us via <a href="https://github.com/17number/enr-relics-merger/issues/new" target="_blank" style="padding: 0; margin: 0;">Issues</a>. We will respond as much as possible. It would be helpful if you could check for <a href="http://github.com/17number/enr-relics-merger/issues?q=is%3Aissue" target="_blank" style="padding: 0; margin: 0;">similar issues</a> beforehand.`,
    noteSummary: "Notes (Click to Expand)",
    outputExample: "Output Example:",
    pattern1: "Pattern 1 (Relic Rites Screen)",
    pattern2: "Pattern 2 (Status Screen)",
    pattern3: "Pattern 3 (Preset Screen)",
    patternPreset: "Preset Screen",
    patternRitual: "Relic Rites Screen",
    patternSelect: "Screen Type",
    patternStatus: "Status Screen",
    progress: "Processing...",
    qrEmbed: "With Generated By/QR Code",
    relic1: "Relic 1",
    relic2: "Relic 2",
    relic1_3: "Relics 1–3",
    relic4_6: "Relics 4–6",
    reset: "Reset",
    result: "Result",
    sample: "Examples",
    swap: "Swap Images",
    title: "ELDEN RING NIGHTREIGN Relic Image Combiner",
  }
};

function judgeLang() {
  const url = new URL(location.href);
  return url.pathname.match(/\/en\/?$/) ? "en" : "ja";
}

function t(key) {
  const lang = judgeLang();
  return (i18n[lang] && i18n[lang][key]) || key;
}

/********************
  * トースト通知
  ********************/
function showToast(message, type="info", duration=3000){
  const toast = document.getElementById("toast");
  toast.textContent = message;
  if(type==="error") toast.style.background="rgba(220,53,69,0.85)";
  else if(type==="success") toast.style.background="rgba(40,167,69,0.85)";
  else toast.style.background="rgba(0,0,0,0.85)";
  toast.style.opacity=1;
  toast.style.pointerEvents="auto";
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(()=>{
    toast.style.opacity=0;
    toast.style.pointerEvents="none";
  }, duration);
}

function loadLatestScreenType() {
  const pattern = localStorage.getItem("selectedPattern") || "ritual";
  if (!["ritual", "status", "preset", "original", "history"].includes(pattern)) {
    return;
  }

  document.querySelectorAll(`input[name="pattern"]`).forEach(radio => radio.checked = false);
  document.querySelector(`input[name="pattern"][value="${pattern}"]`).checked = true;
}
loadLatestScreenType();

/********************
  * メイン処理
  ********************/
const fileBlocks = Array.from(document.querySelectorAll(".file-block"));
const fileInputs = Array.from(document.querySelectorAll(".file-block [id*='file']"));
const previews = Array.from(document.querySelectorAll(".file-block .preview"));
const resets = Array.from(document.querySelectorAll(".file-block [id*='reset']"));
const swapBtn = document.getElementById("swap");
const resetBtn = document.getElementById("reset");
const addTextQrCheckbox = document.getElementById("add-text-qr");
const copyBtn = document.getElementById("copy");
const downloadLink = document.getElementById("download");
const downloadNameInput = document.getElementById("download_name");
const outputDiv = document.getElementById("output");
const outputImg = document.getElementById("output-img");
const dropZone = document.getElementById("drop-zone");

// 画面タイプ選択
let selectedPattern = localStorage.getItem("selectedPattern") || "ritual";
const toggleHistoryInputs = () => {
  const styleDisplay = selectedPattern === "history" ? "flex" : "none";
  document.querySelectorAll("[id*='history-inputs']").forEach((block, index) => {
    block.style.display = styleDisplay;
  });
  if (selectedPattern === "history") {
    document.getElementById('relic1').textContent = t('relic1');
    document.getElementById('relic2').textContent = t('relic2');
    dropZone.textContent = t('dropHere6');
    swapBtn.style.display = "none";
  } else {
    document.getElementById('relic1').textContent = t('relic1_3');
    document.getElementById('relic2').textContent = t('relic4_6');
    dropZone.textContent = t('dropHere');
    swapBtn.style.display = "";
  }
};
toggleHistoryInputs();
document.querySelectorAll('input[name="pattern"]').forEach(radio=>{
  radio.addEventListener("change",e=>{
    selectedPattern=e.target.value;
    localStorage.setItem("selectedPattern", selectedPattern);
    toggleHistoryInputs();
    generateMergedImage();
  });
});

addTextQrCheckbox.addEventListener("change", generateMergedImage);

async function loadImage(file){
  if (!file) return null;

  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>resolve(img);
      img.src=e.target.result;
    };
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

function setPreview(file, preview, reset){
  const reader=new FileReader();
  reader.onload=e=>{
    preview.src=e.target.result;
    preview.style.display="block";
    reset.style.display="inline-block";
  };
  reader.readAsDataURL(file);
}

fileInputs.forEach((fileInput, i) => {
  fileInput.addEventListener("change",()=>{ setPreview(fileInput.files[0], previews[i], resets[i]); generateMergedImage(); });
});

/**
  * ペースト
  */
document.addEventListener('paste', (e) => {
  const files = fileInputs.map(input => input.files[0]);
  const isHistoryPattern = selectedPattern === 'history';
  if (!isHistoryPattern && files[0] && files[1]) {
    showToast(t("alertBothFramesFilledForPaste"), "error");
    return;
  } else if (isHistoryPattern && files.every(f => f)) {
    showToast(t("alertBothFramesFilledForPaste"), "error"); // FIXME: error text
    return;
  }

  const items = e.clipboardData.items;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      const file = item.getAsFile();
      const emptyIndex = files.findIndex(f => !f);
      if (emptyIndex === -1) {
        break;
      }

      const dt = new DataTransfer();
      dt.items.add(file);
      fileInputs[emptyIndex].files = dt.files;
      setPreview(fileInputs[emptyIndex].files[0], previews[emptyIndex], resets[emptyIndex]);
    }
  }

  generateMergedImage();
});

swapBtn.addEventListener("click", () => {
  if (selectedPattern === "history") {
    return;
  }

  // ファイルオブジェクトを入れ替え
  const tempFiles = fileInputs[0].files;
  fileInputs[0].files = fileInputs[1].files;
  fileInputs[1].files = tempFiles;

  // プレビューも入れ替え
  const tempSrc = previews[0].src;
  previews[0].src = previews[1].src;
  previews[1].src = tempSrc;

  // プレビュー表示制御
  previews[0].style.display = fileInputs[0].files[0] ? "block" : "none";
  previews[1].style.display = fileInputs[1].files[0] ? "block" : "none";

  // リセットボタン表示制御
  resets[0].style.display = fileInputs[0].files[0] ? "inline-block" : "none";
  resets[1].style.display = fileInputs[1].files[0] ? "inline-block" : "none";

  generateMergedImage();
});

// 全体リセットボタン
function handleReset(){
  fileInputs.forEach(input=>input.value="");
  outputDiv.style.display="none";
  [...previews, document.querySelector("#output-img")].forEach(img=>{ img.src=""; img.style.display="none"; });
  document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
  document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
  document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
  resets.forEach(btn=>{ btn.style.display="none"; });
};
resetBtn.addEventListener("click", handleReset);

// 個別リセットボタン
function handleResetIndividual(resetId, fileInputId, previewId){
  document.getElementById(fileInputId).value="";
  outputDiv.style.display="none";
  document.getElementById(previewId).src="";
  document.getElementById(previewId).style.display="none";
  document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);
  document.querySelectorAll("#copy, #download").forEach(btn=>{ btn.style.display="none"; });
  document.querySelectorAll(".ios-copy-info").forEach(el=>el.remove());
  document.getElementById(resetId).style.display="none";
  generateMergedImage();
};
resets.forEach((reset, index) => {
  reset.addEventListener("click",() => {
    handleResetIndividual(`reset${index + 1}`,`file${index + 1}`,`preview${index + 1}`);
  })
});

function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
function isSafari() {
  const ua = navigator.userAgent;
  return /^((?!chrome|android).)*safari/i.test(ua);
}
copyBtn.onclick=async()=>{
  const canvas=document.getElementById("canvas");
  canvas.toBlob(async blob=>{
    try{
      await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
      showToast(t("alertCopySuccess"), "success");
      gtag('event', 'clipboard_copy', {
        event_category: 'ui_action',
        event_label: 'Copy Button',
        pattern: selectedPattern,
        qr: addTextQrCheckbox.checked ? 'on' : 'off',
      });
    }
    catch(e){ showToast(t("alertCopyError")+e,"error");}
  },"image/png");
};

function getCropBox(img) {
  if (!img) return { x: 0, y: 0, w: 0, h: 0 };

  if(selectedPattern==="ritual"){
    return { x: img.width*0.05, y: img.height*0.1125, w: img.width*0.36, h: img.height*0.814 };
  } else if (selectedPattern==="status") {
    return { x: img.width*0.35, y: img.height*0.27, w: img.width*0.4375, h: img.height*0.6178 };
  } else if (selectedPattern==="preset") {
    return { x: img.width*0.41, y: img.height*0.14, w: img.width*0.425, h: img.height*0.65 };
  } else if (selectedPattern==="history") {
    return { x: img.width*0.303, y: img.height*0.17, w: img.width*0.385, h: img.height*0.33 };
  }
  return { x: 0, y: 0, w: img.width, h: img.height };
}

function handleClickDownloadLink(e) {
  if (!e.isTrusted) {
    return;
  }

  e.preventDefault();

  // ファイル名設定
  const userCustomName = downloadNameInput.value.trim();
  if (userCustomName) {
    downloadLink.download = userCustomName.endsWith(".jpg") ? userCustomName : `${userCustomName}.jpg`;
  } else {
    // デフォルトファイル名生成
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const dd = String(now.getDate()).padStart(2,'0');
    const hh = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    const defaultName = `enr_merged_relics_${yyyy}${mm}${dd}_${hh}${min}${ss}.jpg`;
    downloadLink.download = defaultName;
  }

  // ダウンロード実行
  e.target.click();

  gtag('event', 'download_image', {
    event_category: 'ui_action',
    event_label: 'Download Image',
    pattern: selectedPattern,
    qr: addTextQrCheckbox.checked ? 'on' : 'off',
    file_name: userCustomName ? 'custom' : 'default',
  });
}
downloadLink.addEventListener("click", handleClickDownloadLink);

async function generateMergedImage() {
  const files = fileInputs.map(input => input.files[0]);
  if(files.every(f => !f)){ return; }
  else if (selectedPattern === "history" && files.some(f => !f)) {
    outputDiv.style.display="none";
    return;
  }

  // 一部要素を初期化
  document.querySelectorAll("#output-img").forEach(img=>{ img.src=""; img.style.display="none"; });
  document.getElementById("canvas").getContext("2d").clearRect(0,0,document.getElementById("canvas").width,document.getElementById("canvas").height);

  const imgs = await Promise.all(files.map(file => loadImage(file)));
  const crops = imgs.map(img => getCropBox(img));

  // Canvas サイズ（文字＋QRスペース分 高さを少し追加）
  const canvas = document.getElementById("canvas");
  let isDrawQrCode = addTextQrCheckbox.checked;
  let ctx, fontSize, qrSize;
  if (selectedPattern !== "history") {
    const crop1 = crops[0];
    const crop2 = crops[1];
    canvas.width = crop1.w + crop2.w;
    canvas.height = crop1.h || crop2.h;
    const baseWidth = crop1.w || crop2.w;
    const baseHeight = crop1.h || crop2.h;
    isDrawQrCode = isDrawQrCode && imgs[0] && imgs[1];
    const multiplier = Math.min(baseWidth, baseHeight) / Math.max(baseWidth, baseHeight);
    fontSize = Math.max(12, baseHeight * multiplier * 0.04);  // 最小12px
    qrSize = Math.max(40, baseHeight * multiplier * 0.12);   // 最小40px
    if (isDrawQrCode) {
      canvas.height += Math.max(qrSize, fontSize) + 10;
    }

    ctx = canvas.getContext("2d");

    // 元画像描画
    if (imgs[0]) {
      ctx.drawImage(imgs[0], crop1.x, crop1.y, crop1.w, crop1.h, 0, 0, crop1.w, crop1.h);
    }
    if (imgs[1]) {
      ctx.drawImage(imgs[1], crop2.x, crop2.y, crop2.w, crop2.h, crop1.w, 0, crop2.w, crop2.h);
    }
  } else {
    const crop1 = crops[0];
    canvas.width = crop1.w * 2;
    canvas.height = crop1.h * 3;
    const baseWidth = canvas.width;
    const baseHeight = canvas.height;
    const multiplier = Math.min(baseWidth, baseHeight) / Math.max(baseWidth, baseHeight);
    fontSize = Math.max(12, baseHeight * multiplier * 0.04);  // 最小12px
    qrSize = Math.max(40, baseHeight * multiplier * 0.12);   // 最小40px
    if (isDrawQrCode) {
      canvas.height += Math.max(qrSize, fontSize) + 10;
    }

    ctx = canvas.getContext("2d");

    // 元画像描画
    imgs.forEach((img, index) => {
      const crop = crops[index];
      const x = index < 3 ? 0 : crop.w;
      const y = (index % 3) * crop.h;
      ctx.drawImage(img, crop.x, crop.y, crop.w, crop.h, x, y, crop.w, crop.h);
    });
  }

  if (isDrawQrCode) {
    // 文字描画
    const text1 = t("generatedBy");
    const text2 = `https://17number.github.io/enr-relics-merger/`;
    ctx.font = `${fontSize}px sans-serif`;
    ctx.fillStyle = "white";
    ctx.strokeStyle = "lightskyblue";
    ctx.textAlign = "left";
    ctx.strokeText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
    ctx.fillText(text1, fontSize * 0.5, canvas.height - (fontSize * 2.0));
    ctx.strokeText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));
    ctx.fillText(text2, fontSize * 0.5, canvas.height - (fontSize * 0.5));

    // QRコード生成
    const qr = qrcode(0, 'L');
    qr.addData(text2);
    qr.make();
    const qrCanvas = document.createElement("canvas");
    qrCanvas.width = qrSize;
    qrCanvas.height = qrSize;
    const qrCtx = qrCanvas.getContext("2d");
    const tileW = qrSize / qr.getModuleCount();
    const tileH = qrSize / qr.getModuleCount();
    for(let r=0; r<qr.getModuleCount(); r++){
      for(let c=0; c<qr.getModuleCount(); c++){
        qrCtx.fillStyle = qr.isDark(r, c) ? "#293179" : "#ffffff";
        qrCtx.fillRect(c*tileW, r*tileH, tileW, tileH);
      }
    }
    // Canvas に QR を貼り付け（右下）
    ctx.drawImage(qrCanvas, canvas.width - qrSize - 10, canvas.height - qrSize - 5);
  }

  // 出力画像
  const dataUrl = canvas.toDataURL("image/jpeg");
  outputImg.src = dataUrl;
  outputImg.style.display = "block";
  outputDiv.style.display = "block";

  showToast(t("alertGenerateSuccess"), "success");

  // ダウンロード設定
  downloadLink.href = dataUrl;
  downloadLink.style.display = "inline-block";

  // iOS 対応コピー
  document.querySelectorAll(".ios-copy-info").forEach(el => el.remove());
  if (!isiOS() && !isSafari()){
    copyBtn.style.display="inline-block";
  } else {
    // Safari や iOS で Clipboard API が使えない場合はコピー非表示
    copyBtn.style.display="none";
    const infoText = document.createElement("p");
    infoText.id = "ios-copy-info";
    if (isiOS()) {
      infoText.textContent = t("longTap");
    } else {
      infoText.textContent = t("longTapOrRightClick");
    }
    infoText.style.color="#555";
    infoText.style.margin="0";
    infoText.classList.add("ios-copy-info");
    copyBtn.parentElement.insertAdjacentElement("beforeend", infoText);
  }

  const isMergeImage = (
    (selectedPattern !== "history" && imgs.filter(img => img).length === 2) ||
    (selectedPattern === "history" && imgs.filter(img => img).length === 6)
  );
  if (isMergeImage) {
    gtag('event', 'merge_image', {
      event_category: 'ui_action',
      event_label: 'Merge Image',
      pattern: selectedPattern,
      qr: isDrawQrCode ? 'on' : 'off',
    });
  } else {
    gtag('event', 'crop_image', {
      event_category: 'ui_action',
      event_label: 'Crop Image',
      pattern: selectedPattern,
    });
  }
}

// ドラッグ＆ドロップ
dropZone.addEventListener("dragover",e=>{
  e.preventDefault();
  dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave",()=>{
  dropZone.classList.remove("dragover");
});
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");

  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
  if(files.length === 0) return;

  // 1枚ドロップ
  if (files.length === 1){
    const emptyIndex = fileInputs.findIndex(input => !input.files[0]);
    if (emptyIndex === -1) {
      showToast(t("alertBothFramesFilled"), "error");
      return;
    } else if (emptyIndex > 1 && selectedPattern !== "history") {
      showToast(t("alertBothFramesFilled"), "error"); // FIXME: error text
      return;
    }

    const dt = new DataTransfer();
    dt.items.add(files[0]);
    fileInputs[emptyIndex].files = dt.files;
    setPreview(files[0], previews[emptyIndex], resets[emptyIndex]);
  } else if (selectedPattern !== "history") {
    // 2枚以上ドロップ → 総入れ替え
    const dt1 = new DataTransfer();
    const dt2 = new DataTransfer();
    dt1.items.add(files[0]);
    dt2.items.add(files[1]);
    fileInputs[0].files = dt1.files;
    fileInputs[1].files = dt2.files;
    setPreview(files[0], previews[0], resets[0]);
    setPreview(files[1], previews[1], resets[1]);
  } else {
    for (const file of files) {
      const emptyIndex = fileInputs.findIndex(input => !input.files[0]);
      if (emptyIndex === -1) break;
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInputs[emptyIndex].files = dt.files;
      setPreview(file, previews[emptyIndex], resets[emptyIndex]);
    }
  }

  generateMergedImage();
});

// 個別ドラッグ＆ドロップ
function enableDropOnBlock(blockEl, previewEl, resetEl, fileInput) {
  // ドラッグ中の見た目を変える
  blockEl.addEventListener("dragover", e => {
    e.preventDefault();
    blockEl.style.border = "2px dashed #3399ff";
    blockEl.style.background = "#3399ff33";
  });

  blockEl.addEventListener("dragleave", () => {
    blockEl.style.border = "";
    blockEl.style.background = "";
  });

  // ドロップされたときの処理
  blockEl.addEventListener("drop", e => {
    e.preventDefault();
    blockEl.style.border = "";
    blockEl.style.background = "";
    if (!e.dataTransfer.files.length) return;

    const file = e.dataTransfer.files[0];
    if (!file.type.startsWith("image/")) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      setPreview(fileInput.files[0], previewEl, resetEl);
      generateMergedImage();
    };
    reader.readAsDataURL(file);
  });
}

// .file-block をドロップ対象にする
fileBlocks.forEach((fileBlock, i) => {
  enableDropOnBlock(fileBlock, previews[i], resets[i], fileInputs[i]);
});

// オーバーレイ
function enableOverlay(selector) {
  document.querySelectorAll(selector).forEach(img => {
    img.addEventListener("click", () => {
      const overlay = document.getElementById("overlay");
      const overlayImg = document.getElementById("overlay-img");
      overlayImg.src = img.src;
      overlay.classList.add("active");
    });
  });
}
enableOverlay("[id*='preview'], #output-img, .sample-area img");
const overlay=document.getElementById("overlay");
overlay.addEventListener("click",()=>overlay.classList.remove("active"));

// バージョン情報取得・表示
const loaderUrl = new URL(document.currentScript.src);
const base = loaderUrl.pathname.replace(/\/assets\/index\.js$/, "");
const versionUrl = `${base}/version.json`;
fetch(versionUrl)
  .then(res => res.json())
  .then(v => {
    const hash = v.hash;
    const date = new Date(v.date).toLocaleString();
    document.getElementById("version").textContent =
      `Commit: ${hash} (${date})`;
  })
  .catch(() => {});
